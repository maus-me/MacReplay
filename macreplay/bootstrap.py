import atexit
from macreplay.runtime_state import (
    RuntimeState,
    SchedulerState,
    SettingsState,
    EpgState,
    PortalState,
    EditorState,
    MiscState,
    HdhrState,
    PlaylistState,
    StreamingState,
)


def start_runtime(
    *,
    loadConfig,
    init_db,
    getPortals,
    logger,
    start_refresh,
    hls_manager,
    enable_jobs=True,
):
    loadConfig()
    init_db(getPortals, logger)
    if enable_jobs:
        start_refresh()
        hls_manager.start_monitoring()
        atexit.register(hls_manager.cleanup_all)


def build_runtime_state(
    *,
    logger,
    job_manager,
    get_epg_refresh_interval,
    get_channel_refresh_interval,
    create_settings_blueprint,
    create_epg_blueprint,
    create_portal_blueprint,
    create_editor_blueprint,
    create_misc_blueprint,
    create_hdhr_blueprint,
    create_playlist_blueprint,
    create_streaming_blueprint,
    refresh_xmltv,
    refresh_xmltv_for_epg_ids,
    refresh_xmltv_for_portal,
    get_cached_xmltv,
    get_last_updated,
    get_epg_refresh_status,
    getPortals,
    get_db_connection,
    effective_epg_name,
    getSettings,
    open_epg_source_db,
    savePortals,
    ACTIVE_GROUP_CONDITION,
    channelsdvr_match_status,
    channelsdvr_match_status_lock,
    normalize_mac_data,
    defaultPortal,
    DB_PATH,
    set_cached_xmltv,
    filter_cache,
    get_epg_channel_ids,
    get_epg_channel_map,
    suggest_channelsdvr_matches,
    host,
    refresh_lineup,
    set_last_playlist_host,
    refresh_custom_sources,
    get_epg_source_status,
    LOG_DIR,
    occupied,
    get_cached_lineup,
    effective_display_name,
    get_cached_playlist,
    set_cached_playlist,
    get_last_playlist_host,
    moveMac,
    score_mac_for_selection,
    hls_manager,
):
    return RuntimeState(
        logger=logger,
        job_manager=job_manager,
        scheduler=SchedulerState(
            logger=logger,
            job_manager=job_manager,
            get_epg_refresh_interval=get_epg_refresh_interval,
            get_channel_refresh_interval=get_channel_refresh_interval,
        ),
        settings=SettingsState(
            create_settings_blueprint=create_settings_blueprint,
            enqueue_epg_refresh=job_manager.enqueue_epg_refresh,
        ),
        epg=EpgState(
            create_epg_blueprint=create_epg_blueprint,
            refresh_xmltv=refresh_xmltv,
            refresh_xmltv_for_epg_ids=refresh_xmltv_for_epg_ids,
            enqueue_epg_refresh=job_manager.enqueue_epg_refresh,
            get_cached_xmltv=get_cached_xmltv,
            get_last_updated=get_last_updated,
            get_epg_refresh_status=get_epg_refresh_status,
            logger=logger,
            getPortals=getPortals,
            get_db_connection=get_db_connection,
            effective_epg_name=effective_epg_name,
            getSettings=getSettings,
            open_epg_source_db=open_epg_source_db,
        ),
        portal=PortalState(
            create_portal_blueprint=create_portal_blueprint,
            logger=logger,
            getPortals=getPortals,
            savePortals=savePortals,
            getSettings=getSettings,
            get_db_connection=get_db_connection,
            ACTIVE_GROUP_CONDITION=ACTIVE_GROUP_CONDITION,
            channelsdvr_match_status=channelsdvr_match_status,
            channelsdvr_match_status_lock=channelsdvr_match_status_lock,
            normalize_mac_data=normalize_mac_data,
            job_manager=job_manager,
            defaultPortal=defaultPortal,
            DB_PATH=DB_PATH,
            set_cached_xmltv=set_cached_xmltv,
            filter_cache=filter_cache,
        ),
        editor=EditorState(
            create_editor_blueprint=create_editor_blueprint,
            logger=logger,
            get_db_connection=get_db_connection,
            ACTIVE_GROUP_CONDITION=ACTIVE_GROUP_CONDITION,
            get_cached_xmltv=get_cached_xmltv,
            get_epg_channel_ids=get_epg_channel_ids,
            get_epg_channel_map=get_epg_channel_map,
            getSettings=getSettings,
            getPortals=getPortals,
            suggest_channelsdvr_matches=suggest_channelsdvr_matches,
            host=host,
            refresh_epg_for_ids=refresh_xmltv_for_epg_ids,
            refresh_lineup=refresh_lineup,
            enqueue_refresh_all=job_manager.enqueue_refresh_all,
            set_last_playlist_host=set_last_playlist_host,
            filter_cache=filter_cache,
            effective_epg_name=effective_epg_name,
        ),
        misc=MiscState(
            create_misc_blueprint=create_misc_blueprint,
            LOG_DIR=LOG_DIR,
            occupied=occupied,
            refresh_custom_sources=refresh_custom_sources,
            get_epg_source_status=get_epg_source_status,
        ),
        hdhr=HdhrState(
            create_hdhr_blueprint=create_hdhr_blueprint,
            host=host,
            getSettings=getSettings,
            refresh_lineup=refresh_lineup,
            get_cached_lineup=get_cached_lineup,
        ),
        playlist=PlaylistState(
            create_playlist_blueprint=create_playlist_blueprint,
            logger=logger,
            host=host,
            getPortals=getPortals,
            getSettings=getSettings,
            get_db_connection=get_db_connection,
            ACTIVE_GROUP_CONDITION=ACTIVE_GROUP_CONDITION,
            effective_display_name=effective_display_name,
            effective_epg_name=effective_epg_name,
            get_cached_playlist=get_cached_playlist,
            set_cached_playlist=set_cached_playlist,
            get_last_playlist_host=get_last_playlist_host,
            set_last_playlist_host=set_last_playlist_host,
        ),
        streaming=StreamingState(
            create_streaming_blueprint=create_streaming_blueprint,
            logger=logger,
            getPortals=getPortals,
            getSettings=getSettings,
            get_db_connection=get_db_connection,
            moveMac=moveMac,
            score_mac_for_selection=score_mac_for_selection,
            occupied=occupied,
            hls_manager=hls_manager,
        ),
    )
