{% extends "base.html" %}

{% block title %}Logs - MacReplay{% endblock %}

{% block head %}
<style>
    .log-container {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
        padding: 15px;
        border-radius: 5px;
        height: 70vh;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .log-line {
        padding: 2px 0;
        border-bottom: 1px solid #2d2d2d;
    }
    .log-line:hover {
        background-color: #2d2d2d;
    }
    .log-level-INFO { color: #4fc3f7; }
    .log-level-WARNING { color: #ffb74d; }
    .log-level-ERROR { color: #ef5350; }
    .log-level-DEBUG { color: #81c784; }
    .log-timestamp { color: #888; }
    .log-controls {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--bs-body-bg);
        padding-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-file-alt"></i> System Logs</h2>
        <p class="text-muted">Live log viewer with auto-refresh</p>
    </div>
</div>

<div class="log-controls">
    <div class="row mb-3">
        <div class="col-auto">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" id="btnPlay" onclick="togglePause()" title="Pause/Resume">
                    <i class="fas fa-pause" id="playIcon"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearDisplay()" title="Clear Display">
                    <i class="fas fa-eraser"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="scrollToBottom()" title="Scroll to Bottom">
                    <i class="fas fa-arrow-down"></i>
                </button>
            </div>
        </div>
        <div class="col-auto">
            <select class="form-select" id="logLevelFilter" onchange="filterLogs()">
                <option value="">All Levels</option>
                <option value="ERROR">Errors Only</option>
                <option value="WARNING">Warnings & Errors</option>
                <option value="INFO">Info & Above</option>
                <option value="DEBUG">Debug (All)</option>
            </select>
        </div>
        <div class="col-auto">
            <select class="form-select" id="lineCount" onchange="changeLineCount()">
                <option value="100">Last 100 lines</option>
                <option value="250">Last 250 lines</option>
                <option value="500" selected>Last 500 lines</option>
                <option value="1000">Last 1000 lines</option>
                <option value="all">All lines</option>
            </select>
        </div>
        <div class="col-auto ms-auto">
            <a href="/log" target="_blank" class="btn btn-outline-primary" title="Download Full Log">
                <i class="fas fa-download"></i> Download
            </a>
        </div>
    </div>
</div>

<div class="log-container" id="logContainer">
    <div class="text-center text-muted py-5">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p class="mt-2">Loading logs...</p>
    </div>
</div>

<div class="row mt-2">
    <div class="col-12">
        <small class="text-muted">
            <span id="statusIndicator" class="text-success"><i class="fas fa-circle"></i></span>
            <span id="statusText">Live</span> |
            Lines: <span id="lineCountDisplay">0</span> |
            Last updated: <span id="lastUpdate">-</span>
        </small>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isPaused = false;
let autoScroll = true;
let refreshInterval;
let allLogLines = [];
const REFRESH_RATE = 2000; // 2 seconds

function fetchLogs() {
    if (isPaused) return;

    const lineCount = document.getElementById('lineCount').value;
    const url = lineCount === 'all' ? '/logs/stream' : `/logs/stream?lines=${lineCount}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            allLogLines = data.lines || [];
            filterLogs();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        })
        .catch(error => {
            console.error('Error fetching logs:', error);
            document.getElementById('statusIndicator').className = 'text-danger';
            document.getElementById('statusText').textContent = 'Error';
        });
}

function filterLogs() {
    const filter = document.getElementById('logLevelFilter').value;
    const container = document.getElementById('logContainer');

    let filteredLines = allLogLines;

    if (filter) {
        const levels = {
            'ERROR': ['ERROR'],
            'WARNING': ['ERROR', 'WARNING'],
            'INFO': ['ERROR', 'WARNING', 'INFO'],
            'DEBUG': ['ERROR', 'WARNING', 'INFO', 'DEBUG']
        };
        const allowedLevels = levels[filter] || [];
        filteredLines = allLogLines.filter(line => {
            return allowedLevels.some(level => line.includes(`[${level}]`));
        });
    }

    renderLogs(filteredLines);
}

function renderLogs(lines) {
    const container = document.getElementById('logContainer');
    const wasAtBottom = isScrolledToBottom();

    if (lines.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-5">No log entries found</div>';
        document.getElementById('lineCountDisplay').textContent = '0';
        return;
    }

    let html = '';
    lines.forEach(line => {
        const formattedLine = formatLogLine(line);
        html += `<div class="log-line">${formattedLine}</div>`;
    });

    container.innerHTML = html;
    document.getElementById('lineCountDisplay').textContent = lines.length;

    if (autoScroll && wasAtBottom) {
        scrollToBottom();
    }
}

function formatLogLine(line) {
    // Highlight log levels
    let formatted = line
        .replace(/\[INFO\]/g, '<span class="log-level-INFO">[INFO]</span>')
        .replace(/\[WARNING\]/g, '<span class="log-level-WARNING">[WARNING]</span>')
        .replace(/\[ERROR\]/g, '<span class="log-level-ERROR">[ERROR]</span>')
        .replace(/\[DEBUG\]/g, '<span class="log-level-DEBUG">[DEBUG]</span>');

    // Highlight timestamp
    formatted = formatted.replace(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})/, '<span class="log-timestamp">$1</span>');

    return formatted;
}

function togglePause() {
    isPaused = !isPaused;
    const btn = document.getElementById('btnPlay');
    const icon = document.getElementById('playIcon');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');

    if (isPaused) {
        btn.classList.remove('btn-success');
        btn.classList.add('btn-warning');
        icon.classList.remove('fa-pause');
        icon.classList.add('fa-play');
        statusIndicator.className = 'text-warning';
        statusText.textContent = 'Paused';
    } else {
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        icon.classList.remove('fa-play');
        icon.classList.add('fa-pause');
        statusIndicator.className = 'text-success';
        statusText.textContent = 'Live';
        fetchLogs(); // Fetch immediately when resuming
    }
}

function clearDisplay() {
    document.getElementById('logContainer').innerHTML = '<div class="text-center text-muted py-5">Display cleared</div>';
    document.getElementById('lineCountDisplay').textContent = '0';
}

function scrollToBottom() {
    const container = document.getElementById('logContainer');
    container.scrollTop = container.scrollHeight;
}

function isScrolledToBottom() {
    const container = document.getElementById('logContainer');
    return container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
}

function changeLineCount() {
    fetchLogs();
}

// Track scroll position to disable auto-scroll when user scrolls up
document.getElementById('logContainer').addEventListener('scroll', function() {
    autoScroll = isScrolledToBottom();
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    fetchLogs();
    refreshInterval = setInterval(fetchLogs, REFRESH_RATE);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
