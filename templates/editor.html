{% extends "base.html" %}

{% block head %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
<!-- Tom Select for searchable multi-select -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
{% endblock %}

{% block content %}

<!-- Toast Notification -->
<div class="toast-overlay" id="toastOverlay" onclick="hideNotification()"></div>
<div class="toast-notification" id="toastNotification">
    <div class="toast-icon"><i class="fas fa-check-circle"></i></div>
    <div class="toast-message" id="toastMessage">Message</div>
</div>

<div class="container-fluid p-lg-5">
    <!-- Filter Controls -->
    <div class="card mb-3 filter-card">
        <div class="card-body py-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="portalFilter" class="form-label small mb-1">Portal</label>
                    <select id="portalFilter" multiple placeholder="All Portals...">
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="groupFilter" class="form-label small mb-1">Group</label>
                    <select id="groupFilter" multiple placeholder="All Groups...">
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="duplicateFilter" class="form-label small mb-1">Duplicates</label>
                    <select id="duplicateFilter">
                        <option value="">All Channels</option>
                        <option value="enabled_only">Enabled Duplicates Only</option>
                        <option value="unique_only">Unique Only</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchFilter" class="form-label small mb-1">Search</label>
                    <input type="text" id="searchFilter" class="form-control" placeholder="Filter channels...">
                </div>
            </div>
        </div>
    </div>

    <table id="table" class="table table-striped nowrap" width="100%">
        <thead>
            <tr>
                <th>
                    <div class="form-check form-switch">
                        <input type="checkbox" class="checkbox form-check-input" onchange="editAll(this)">
                    </div>
                </th>
                <th>Play</th>
                <th>Name</th>
                <th>Group</th>
                <th>Number</th>
                <th>EPG ID</th>
                <th>Fallback For</th>
                <th>Portal</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <form action="/editor/save" method="post" id="save-edits" hidden>
        <input type="text" id="enabledEdits" name="enabledEdits" value="">
        <input type="text" id="numberEdits" name="numberEdits" value="">
        <input type="text" id="nameEdits" name="nameEdits" value="">
        <input type="text" id="groupEdits" name="groupEdits" value="">
        <input type="text" id="epgEdits" name="epgEdits" value="">
        <input type="text" id="fallbackEdits" name="fallbackEdits" value="">
    </form>

    <form action="/editor/reset" method="post" id="reset" hidden>
    </form>

    <!-- Channel Names Datalist for Fallback Suggestions -->
    <datalist id="channelNamesList">
        <!-- Options will be populated dynamically -->
    </datalist>

    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="channelLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="channelLabel">Channel</h5>
                </div>
                <div class="modal-body">
                    <video width="100%" id="player" controls autoplay>
                        <source src="" type="video/mp4">
                        Your browser does not support HTML video.
                    </video>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Confirm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-start">
                        <div class="confirm-icon me-3" id="confirmModalIcon">
                            <i class="fas fa-question-circle fa-2x text-warning"></i>
                        </div>
                        <div>
                            <p class="mb-0" id="confirmModalMessage">Are you sure?</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmModalOk">
                        <i class="fas fa-check"></i> <span id="confirmModalOkText">OK</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Channel Info Modal -->
    <div class="modal fade" id="channelInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <span id="channelInfoTitle">Channel Details</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Logo -->
                        <div class="col-12 mb-3 text-center" id="channelInfoLogoContainer" style="display: none;">
                            <img id="channelInfoLogo" src="" alt="Channel Logo" style="max-height: 80px; max-width: 200px;">
                        </div>

                        <!-- Basic Info -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-tv me-2"></i>Channel Info</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Channel ID</th><td><code id="infoChannelId"></code></td></tr>
                                <tr><th>Name</th><td id="infoName"></td></tr>
                                <tr><th>Custom Name</th><td id="infoCustomName"></td></tr>
                                <tr><th>Number</th><td id="infoNumber"></td></tr>
                                <tr><th>Custom Number</th><td id="infoCustomNumber"></td></tr>
                                <tr><th>Enabled</th><td id="infoEnabled"></td></tr>
                            </table>
                        </div>

                        <!-- Group/Genre Info -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-folder me-2"></i>Group Info</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Genre</th><td id="infoGenre"></td></tr>
                                <tr><th>Genre ID</th><td><code id="infoGenreId"></code></td></tr>
                                <tr><th>Custom Genre</th><td id="infoCustomGenre"></td></tr>
                                <tr><th>Portal</th><td id="infoPortalName"></td></tr>
                                <tr><th>Portal ID</th><td><code id="infoPortalId" style="font-size: 0.75em;"></code></td></tr>
                            </table>
                        </div>

                        <!-- EPG & Fallback -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-calendar me-2"></i>EPG & Fallback</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Has EPG</th><td id="infoHasEpg"></td></tr>
                                <tr><th>Custom EPG ID</th><td id="infoCustomEpgId"></td></tr>
                                <tr><th>Fallback For</th><td id="infoFallback"></td></tr>
                                <tr><th>Duplicates</th><td id="infoDuplicates"></td></tr>
                            </table>
                        </div>

                        <!-- Stream URL -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-link me-2"></i>Stream</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Play URL</th><td><code id="infoLink" style="font-size: 0.7em; word-break: break-all;"></code></td></tr>
                            </table>
                        </div>

                        <!-- Alternate IDs -->
                        <div class="col-md-6 mt-3">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-code-branch me-2"></i>Alternate IDs</h6>
                            <div id="infoAlternateIds">
                                <p class="text-muted">No alternate IDs</p>
                            </div>
                        </div>

                        <!-- Available MACs -->
                        <div class="col-md-6 mt-3">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-network-wired me-2"></i>Available MACs</h6>
                            <div id="infoMacsContainer">
                                <p class="text-muted">No MACs available</p>
                            </div>
                        </div>

                        <!-- Merge Section -->
                        <div class="col-12 mt-3">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-object-group me-2"></i>Merge Duplicate</h6>
                            <p class="small text-muted mb-2">
                                Merge another channel into this one. The other channel's ID becomes an alternate ID,
                                and the system will try it as fallback if the primary ID fails.
                            </p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="mergeChannelSearch"
                                       placeholder="Search for channel to merge..." autocomplete="off">
                                <button class="btn btn-warning" type="button" id="mergeChannelBtn" disabled>
                                    <i class="fas fa-object-group"></i> Merge
                                </button>
                            </div>
                            <div id="mergeSearchResults" class="list-group mt-1" style="max-height: 150px; overflow-y: auto; display: none;"></div>
                            <input type="hidden" id="mergeTargetPortal" value="">
                            <input type="hidden" id="mergeTargetChannelId" value="">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<!-- Load jQuery and DataTables -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<!-- Tom Select for searchable multi-select -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
    // Toast Notification Functions
    function showNotification(message, type = 'success', duration = 3000) {
        const toast = document.getElementById('toastNotification');
        const overlay = document.getElementById('toastOverlay');
        const messageEl = document.getElementById('toastMessage');
        const iconEl = toast.querySelector('.toast-icon i');

        // Set message
        messageEl.textContent = message;

        // Set type (success, error, info)
        toast.className = 'toast-notification ' + type;

        // Set icon
        if (type === 'success') {
            iconEl.className = 'fas fa-check-circle';
        } else if (type === 'error') {
            iconEl.className = 'fas fa-times-circle';
        } else {
            iconEl.className = 'fas fa-info-circle';
        }

        // Show
        toast.classList.add('show');
        overlay.classList.add('show');

        // Auto-hide after duration
        setTimeout(hideNotification, duration);
    }

    function hideNotification() {
        const toast = document.getElementById('toastNotification');
        const overlay = document.getElementById('toastOverlay');
        toast.classList.remove('show');
        overlay.classList.remove('show');
    }

    // Confirmation Dialog Function
    function showConfirmDialog(options) {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmModalTitle');
            const messageEl = document.getElementById('confirmModalMessage');
            const iconEl = document.getElementById('confirmModalIcon');
            const okBtn = document.getElementById('confirmModalOk');
            const okTextEl = document.getElementById('confirmModalOkText');

            // Set content
            titleEl.textContent = options.title || 'Confirm';
            messageEl.textContent = options.message || 'Are you sure?';
            okTextEl.textContent = options.okText || 'OK';

            // Set icon and button style based on type
            const type = options.type || 'warning';
            if (type === 'danger') {
                iconEl.innerHTML = '<i class="fas fa-exclamation-triangle fa-2x text-danger"></i>';
                okBtn.className = 'btn btn-danger';
            } else if (type === 'info') {
                iconEl.innerHTML = '<i class="fas fa-info-circle fa-2x text-info"></i>';
                okBtn.className = 'btn btn-primary';
            } else {
                iconEl.innerHTML = '<i class="fas fa-question-circle fa-2x text-warning"></i>';
                okBtn.className = 'btn btn-warning';
            }

            // Create bootstrap modal instance
            const bsModal = new bootstrap.Modal(modal);

            // Handle OK button click
            const handleOk = () => {
                okBtn.removeEventListener('click', handleOk);
                modal.removeEventListener('hidden.bs.modal', handleCancel);
                bsModal.hide();
                resolve(true);
            };

            // Handle Cancel/Close
            const handleCancel = () => {
                okBtn.removeEventListener('click', handleOk);
                resolve(false);
            };

            okBtn.addEventListener('click', handleOk);
            modal.addEventListener('hidden.bs.modal', handleCancel, { once: true });

            // Show modal
            bsModal.show();
        });
    }

    var enabledEdits = [];
    var numberEdits = [];
    var nameEdits = [];
    var groupEdits = [];
    var epgEdits = [];
    var fallbackEdits = [];
    var dataTable;
    var allChannelNamesCount = {}; // Track all channel name frequencies for autocomplete
    var enabledChannelNamesCount = {}; // Track enabled channel name frequencies for duplicate detection

    function editAll(ele) {
        var checkboxes = document.getElementsByClassName('checkbox');
        var enable = ele.checked;
        for (var i = 0, n = checkboxes.length; i < n; i++) {
            if (i != 0) {
                checkboxes[i].checked = enable;
                checkboxes[i].onchange();
            }
        }
    }

    function editEnabled(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.checked;
        var j = { "portal": p, "channel id": i, "enabled": c };
        enabledEdits.push(j);
    }

    function editCustomNumber(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "custom number": c };
        numberEdits.push(j);
    }

    function editCustomName(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "custom name": c };
        nameEdits.push(j);
    }

    function editCustomGroup(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "custom genre": c };
        groupEdits.push(j);
    }

    function editCustomEpgId(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "custom epg id": c };
        epgEdits.push(j);
    }

    function editFallback(ele) {
        var p = ele.getAttribute('data-portal');
        var i = ele.getAttribute('data-channelId');
        var c = ele.value;
        var j = { "portal": p, "channel id": i, "channel name": c };
        fallbackEdits.push(j);
    }

    function save() {
        const formData = new FormData();
        formData.append('enabledEdits', JSON.stringify(enabledEdits));
        formData.append('numberEdits', JSON.stringify(numberEdits));
        formData.append('nameEdits', JSON.stringify(nameEdits));
        formData.append('groupEdits', JSON.stringify(groupEdits));
        formData.append('epgEdits', JSON.stringify(epgEdits));
        formData.append('fallbackEdits', JSON.stringify(fallbackEdits));

        // Show loading indicator
        var saveBtn = $('.dt-button:contains("Save")').first();
        var originalText = saveBtn.html();
        saveBtn.html('<i class="fas fa-spinner fa-spin"></i> Saving...').prop('disabled', true);

        fetch('/editor/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message || 'Playlist config saved!', 'success');
                // Clear edit arrays
                enabledEdits = [];
                numberEdits = [];
                nameEdits = [];
                groupEdits = [];
                epgEdits = [];
                fallbackEdits = [];
                // Reload table data without losing filters
                dataTable.ajax.reload(null, false);
            } else {
                showNotification('Error: ' + (data.error || 'Unknown error'), 'error', 5000);
            }
        })
        .catch(error => {
            showNotification('Error saving changes: ' + error, 'error', 5000);
        })
        .finally(() => {
            saveBtn.html(originalText).prop('disabled', false);
        });
    }

    var player = document.getElementById("player")
    var title = document.getElementById("channelLabel")
    player.volume = 0.25
    function selectChannel(ele) {
        link = ele.getAttribute('data-link');
        player.src = link;
        channel = ele.getAttribute('data-customChannelName');
        if (channel == "") {
            channel = ele.getAttribute('data-channelName');
        }
        title.innerHTML = channel
    }

    $('#videoModal').on('hidden.bs.modal', function () {
        player.src = "";
    })

    /* Create an array with the values of all the checkboxes in a column */
    $.fn.dataTable.ext.order['dom-checkbox'] = function (settings, col) {
        return this.api().column(col, { order: 'index' }).nodes().map(function (td, i) {
            return $('input', td).prop('checked') ? '1' : '0';
        });
    };

    /* Create an array with the values of all the input boxes in a column, parsed as numbers */
    $.fn.dataTable.ext.order['dom-text-numeric'] = function (settings, col) {
        return this.api().column(col, { order: 'index' }).nodes().map(function (td, i) {
            var val = $('input', td).val();
            return val === '' ? $('input', td).attr('placeholder') : val * 1;
        });
    };

    /* Create an array with the values of all the text boxes in a column */
    $.fn.dataTable.ext.order['dom-text'] = function (settings, col) {
        return this.api().column(col, { order: 'index' }).nodes().map(function (td, i) {
            var val = $('input', td).val();
            return val === '' ? $('input', td).attr('placeholder') : val;
        });
    };

    // Tom Select instances
    let portalSelect, groupSelect, duplicateSelect;
    // Store all groups data for dynamic filtering
    let allGroupsData = [];

    // Initialize Tom Select dropdowns
    function initializeFilters() {
        // Portal filter with Tom Select
        portalSelect = new TomSelect('#portalFilter', {
            plugins: ['remove_button', 'clear_button'],
            placeholder: 'All Portals...',
            allowEmptyOption: true,
            closeAfterSelect: false,
            hidePlaceholder: true,
            maxOptions: null,
            onChange: function() {
                updateGroupFilter();
                if (dataTable) dataTable.ajax.reload();
            }
        });

        // Group filter with Tom Select (with optgroup support)
        groupSelect = new TomSelect('#groupFilter', {
            plugins: ['remove_button', 'clear_button'],
            placeholder: 'All Groups...',
            allowEmptyOption: true,
            closeAfterSelect: false,
            hidePlaceholder: true,
            optgroupField: 'portal',
            optgroupLabelField: 'portal',
            optgroupValueField: 'portal',
            lockOptgroupOrder: true,
            maxOptions: null,
            render: {
                optgroup_header: function(data, escape) {
                    return '<div class="optgroup-header">' + escape(data.portal) + '</div>';
                }
            },
            onChange: function() {
                if (dataTable) dataTable.ajax.reload();
            }
        });

        // Duplicate filter with Tom Select (single-select)
        duplicateSelect = new TomSelect('#duplicateFilter', {
            placeholder: 'All Channels',
            allowEmptyOption: true,
            maxOptions: null,
            onChange: function() {
                if (dataTable) dataTable.ajax.reload();
            }
        });

        // Custom search input - connect to DataTable
        let searchTimeout;
        document.getElementById('searchFilter').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                if (dataTable) dataTable.search(e.target.value).draw();
            }, 300);
        });

        // Populate the dropdowns
        populateFilters();
    }

    // Update group filter based on selected portals
    function updateGroupFilter() {
        const selectedPortals = portalSelect.getValue();

        // Clear current options
        groupSelect.clear();
        groupSelect.clearOptions();

        // Filter groups based on selected portals
        let filteredGroups = allGroupsData;
        if (selectedPortals && selectedPortals.length > 0) {
            filteredGroups = allGroupsData.filter(group => selectedPortals.includes(group.portal));
        }

        // Re-add filtered groups
        filteredGroups.forEach(group => {
            groupSelect.addOptionGroup(group.portal, { portal: group.portal });
            group.genres.forEach(genre => {
                groupSelect.addOption({ value: genre, text: genre, portal: group.portal });
            });
        });
    }

    // Populate filter dropdowns
    function populateFilters() {
        // Populate portals dropdown
        fetch('/editor/portals')
            .then(res => res.json())
            .then(data => {
                data.portals.forEach(portal => {
                    portalSelect.addOption({ value: portal, text: portal });
                });
            })
            .catch(err => console.error('Error loading portals:', err));

        // Populate groups dropdown (grouped by portal)
        fetch('/editor/genres-grouped')
            .then(res => res.json())
            .then(data => {
                // Store all groups data for dynamic filtering
                allGroupsData = data.genres_by_portal;

                // Add optgroups for each portal
                data.genres_by_portal.forEach(group => {
                    groupSelect.addOptionGroup(group.portal, { portal: group.portal });
                    group.genres.forEach(genre => {
                        groupSelect.addOption({ value: genre, text: genre, portal: group.portal });
                    });
                });
            })
            .catch(err => console.error('Error loading groups:', err));
    }

    // Helper to get selected values as comma-separated string
    function getFilterValues(selectInstance) {
        const values = selectInstance.getValue();
        if (Array.isArray(values)) {
            return values.join(',');
        }
        return values || '';
    }

    $(document).ready(function () {
        // Initialize Tom Select filter dropdowns
        initializeFilters();

        dataTable = $('#table').DataTable({
            dom: "<'row m-1'<'col-auto'B><'col-auto ms-auto'l>>" +
                "<'row'<'col-12'tr>>" +
                "<'row mb-1 mb-lg-0'<'col-auto text-light'i><'col-auto ms-auto'p>>",
            serverSide: true,
            processing: true,
            order: [[0, 'desc'], [2, 'asc']],
            pageLength: 250,
            lengthMenu: [[25, 50, 100, 250, 500, 1000], [25, 50, 100, 250, 500, 1000]],
            columnDefs: [
                { targets: [0, 1], width: "0%" },
                { targets: 0, className: "align-middle", orderable: false, searchable: false },
                { targets: 1, className: "align-middle", orderable: false, searchable: false },
                { targets: 2, className: "align-middle", type: 'string' },
                { targets: 3, className: "align-middle", type: 'string' },
                { targets: 4, className: "align-middle" },
                { targets: 5, className: "align-middle", type: 'string' },
                { targets: 6, className: "align-middle", type: 'string' },
                { targets: 7, className: "align-middle" }
            ],
            language: {
                search: "",
                searchPlaceholder: 'Filter',
                lengthMenu: "_MENU_",
                processing: "Loading channels..."
            },
            buttons: {
                buttons: [
                    {
                        text: '<i class="fas fa-save"></i> Save',
                        titleAttr: 'Save',
                        className: "btn btn-success",
                        action: function () {
                            save();
                        }
                    },
                    {
                        text: '<i class="fas fa-sync"></i> Refresh Channels',
                        titleAttr: 'Refresh channel list from portal',
                        className: "btn btn-primary",
                        action: function () {
                            refreshChannels();
                        }
                    },
                    {
                        text: '<i class="fas fa-undo"></i> Reset',
                        titleAttr: 'Reset',
                        className: "btn btn-danger",
                        action: async function () {
                            const confirmed = await showConfirmDialog({
                                title: 'Confirm Reset',
                                message: 'This will clear all edits! Are you sure?',
                                type: 'danger',
                                okText: 'Reset'
                            });
                            if (confirmed) {
                                document.getElementById('reset').submit();
                            }
                        }
                    },
                    {
                        text: '<i class="fas fa-trash"></i> Deactivate Duplicates',
                        titleAttr: 'Deactivate enabled duplicate channels (keeps first enabled occurrence)',
                        className: "btn btn-warning",
                        action: function () {
                            deactivateDuplicates();
                        }
                    }
                ],
            },
            ajax: {
                "url": "{{ url_for('editor_data') }}",
                "dataType": "json",
                "contentType": "application/json",
                "data": function(d) {
                    // Add custom filter parameters (comma-separated for multi-select)
                    d.portal = getFilterValues(portalSelect);
                    d.group = getFilterValues(groupSelect);
                    d.duplicates = duplicateSelect ? duplicateSelect.getValue() : '';
                }
            },
            columns: [
                {
                    data: "enabled",
                    render: function (data, type, row, meta) {
                        let r = '<div \
                                class="form-check form-switch">\
                                <input \
                                type="checkbox" \
                                class="checkbox form-check-input" \
                                onchange="editEnabled(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '"'
                        if (data == true) {
                            r = r + ' checked';
                        }
                        r = r + '></div>'
                        return r
                    }
                },
                {
                    data: "link",
                    render: function (data, type, row, meta) {
                        return '<button \
                            class="btn btn-success btn-block" \
                            title="Play" \
                            data-bs-toggle="modal" \
                            data-bs-target="#videoModal" \
                            onclick="selectChannel(this)" \
                            data-channelName="' + row.channelName + '" \
                            data-customChannelName="' + row.customChannelName + '" \
                            data-link="' + row.link + '">\
                            <i class="fas fa-play"></i>\
                        </button>'
                    }
                },
                {
                    data: "channelName",
                    render: function (data, type, row, meta) {
                        var badges = '';
                        if (row.duplicateCount && row.duplicateCount > 1) {
                            badges += '<span class="duplicate-badge">' + row.duplicateCount + 'x</span>';
                        }
                        if (row.hasEpg) {
                            badges += '<span class="epg-badge" title="Has EPG data">EPG</span>';
                        } else {
                            badges += '<span class="no-epg-badge" title="No EPG data">EPG</span>';
                        }
                        return '<div style="display: flex; align-items: center; gap: 5px;">' +
                               '<input \
                                type="text" \
                                class="form-control" \
                                style="width: 100%;" \
                                onchange="editCustomName(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                placeholder="' + row.channelName + '" \
                                title="' + row.channelName + '" \
                                value="' + row.customChannelName + '">' +
                               badges +
                               '</div>';
                    },
                },
                {
                    data: "genre",
                    render: function (data, type, row, meta) {
                        return '<input \
                                type="text" \
                                class="form-control" \
                                style="width: 100%;" \
                                onchange="editCustomGroup(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                placeholder="' + row.genre + '" \
                                title="' + row.genre + '" \
                                value="' + row.customGenre + '">'
                    },
                },
                {
                    data: "channelNumber",
                    render: function (data, type, row, meta) {
                        return '<input \
                                type="text" \
                                class="form-control" \
                                style="width: 100%;" \
                                onchange="editCustomNumber(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                placeholder="' + row.channelNumber + '" \
                                title="' + row.channelNumber + '" \
                                value="' + row.customChannelNumber + '">'
                    },
                },
                {
                    data: "channelId",
                    render: function (data, type, row, meta) {
                        return '<input \
                                type="text" \
                                class="form-control" \
                                style="width: 100%;" \
                                onchange="editCustomEpgId(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                placeholder="' + row.portal + row.channelId + '" \
                                title="' + row.portal + row.channelId + '" \
                                value="' + row.customEpgId + '">'
                    },
                },
                {
                    data: "fallbackChannel",
                    render: function (data, type, row, meta) {
                        return '<input \
                                type="text" \
                                class="form-control" \
                                style="width: 100%;" \
                                list="channelNamesList" \
                                placeholder="Enter channel name..." \
                                title="Type to search or click to see all channel names" \
                                onchange="editFallback(this)" \
                                data-portal="' + row.portal + '" \
                                data-channelId="' + row.channelId + '" \
                                value="' + row.fallbackChannel + '">'
                    }
                },
                {
                    data: "portalName",
                    render: function (data, type, row, meta) {
                        // Store the full row data in a data attribute for the modal
                        const rowDataJson = JSON.stringify(row).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        return '<span class="portal-link" style="cursor: pointer; color: var(--bs-primary); text-decoration: underline;" ' +
                               'onclick="showChannelInfo(this)" ' +
                               'data-row="' + rowDataJson + '">' +
                               (data || 'Unknown') + '</span>';
                    }
                },
            ],
        });

    });
    
    // Function to deactivate duplicate enabled channels
    async function deactivateDuplicates() {
        const confirmed = await showConfirmDialog({
            title: 'Deactivate Duplicates',
            message: 'This will deactivate all duplicate enabled channels, keeping only the first occurrence of each. Continue?',
            type: 'warning',
            okText: 'Deactivate'
        });
        if (!confirmed) return;

        fetch('/editor/deactivate-duplicates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Successfully deactivated ' + data.deactivated + ' duplicate channels!', 'success');
                dataTable.ajax.reload();
            } else {
                showNotification('Error: ' + (data.error || 'Unknown error'), 'error', 5000);
            }
        })
        .catch(error => {
            showNotification('Error deactivating duplicates: ' + error, 'error', 5000);
        });
    }

    // Function to refresh channels from portal
    async function refreshChannels() {
        const confirmed = await showConfirmDialog({
            title: 'Refresh Channels',
            message: 'This will fetch the latest channel list from your portals. This may take a few minutes. Continue?',
            type: 'info',
            okText: 'Refresh'
        });
        if (!confirmed) return;

        // Show loading indicator
        var btn = $('.btn-primary').first();
        var originalText = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i> Refreshing...').prop('disabled', true);

        fetch('{{ url_for("editorRefresh") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('Successfully refreshed ' + data.total + ' channels!', 'success');
                dataTable.ajax.reload();
            } else {
                showNotification('Error refreshing channels: ' + (data.message || 'Unknown error'), 'error', 5000);
            }
        })
        .catch(error => {
            showNotification('Error refreshing channels: ' + error, 'error', 5000);
        })
        .finally(() => {
            btn.html(originalText).prop('disabled', false);
        });
    }

    // Show Channel Info Modal
    function showChannelInfo(element) {
        try {
            const rowDataStr = element.getAttribute('data-row').replace(/&quot;/g, '"');
            const row = JSON.parse(rowDataStr);

            // Set title
            document.getElementById('channelInfoTitle').textContent = row.customChannelName || row.channelName || 'Channel Details';

            // Logo
            const logoContainer = document.getElementById('channelInfoLogoContainer');
            const logoImg = document.getElementById('channelInfoLogo');
            if (row.logo) {
                logoImg.src = row.logo;
                logoContainer.style.display = 'block';
            } else {
                logoContainer.style.display = 'none';
            }

            // Basic Info
            document.getElementById('infoChannelId').textContent = row.channelId || '-';
            document.getElementById('infoName').textContent = row.channelName || '-';
            document.getElementById('infoCustomName').textContent = row.customChannelName || '-';
            document.getElementById('infoNumber').textContent = row.channelNumber || '-';
            document.getElementById('infoCustomNumber').textContent = row.customChannelNumber || '-';
            document.getElementById('infoEnabled').innerHTML = row.enabled
                ? '<span class="badge bg-success">Yes</span>'
                : '<span class="badge bg-secondary">No</span>';

            // Group Info
            document.getElementById('infoGenre').textContent = row.genre || '-';
            document.getElementById('infoGenreId').textContent = row.genreId || '-';
            document.getElementById('infoCustomGenre').textContent = row.customGenre || '-';
            document.getElementById('infoPortalName').textContent = row.portalName || '-';
            document.getElementById('infoPortalId').textContent = row.portal || '-';

            // EPG & Fallback
            document.getElementById('infoHasEpg').innerHTML = row.hasEpg
                ? '<span class="badge bg-success">Yes</span>'
                : '<span class="badge bg-secondary">No</span>';
            document.getElementById('infoCustomEpgId').textContent = row.customEpgId || '-';
            document.getElementById('infoFallback').textContent = row.fallbackChannel || '-';
            document.getElementById('infoDuplicates').innerHTML = row.duplicateCount > 1
                ? '<span class="badge bg-warning text-dark">' + row.duplicateCount + 'x enabled</span>'
                : '<span class="badge bg-secondary">None</span>';

            // Stream URL
            document.getElementById('infoLink').textContent = row.link || '-';

            // Available MACs - Parse and number them
            const macsContainer = document.getElementById('infoMacsContainer');
            if (row.availableMacs && row.availableMacs.trim()) {
                const macs = row.availableMacs.split(',').map(m => m.trim()).filter(m => m);
                if (macs.length > 0) {
                    let macsHtml = '<div class="table-responsive"><table class="table table-sm table-bordered">';
                    macsHtml += '<thead><tr><th style="width: 60px;">#</th><th>MAC Address</th></tr></thead><tbody>';
                    macs.forEach((mac, index) => {
                        macsHtml += '<tr><td><span class="badge bg-primary">' + (index + 1) + '</span></td>';
                        macsHtml += '<td><code>' + mac + '</code></td></tr>';
                    });
                    macsHtml += '</tbody></table></div>';
                    macsContainer.innerHTML = macsHtml;
                } else {
                    macsContainer.innerHTML = '<p class="text-muted mb-0">No MACs available</p>';
                }
            } else {
                macsContainer.innerHTML = '<p class="text-muted mb-0">No MACs available</p>';
            }

            // Alternate IDs
            const alternateIdsContainer = document.getElementById('infoAlternateIds');
            if (row.alternateIds && row.alternateIds.trim()) {
                const altIds = row.alternateIds.split(',').map(id => id.trim()).filter(id => id);
                if (altIds.length > 0) {
                    let altHtml = '<div class="d-flex flex-wrap gap-1">';
                    altIds.forEach(id => {
                        altHtml += '<code class="badge bg-info text-dark">' + id + '</code>';
                    });
                    altHtml += '</div>';
                    alternateIdsContainer.innerHTML = altHtml;
                } else {
                    alternateIdsContainer.innerHTML = '<p class="text-muted mb-0">No alternate IDs</p>';
                }
            } else {
                alternateIdsContainer.innerHTML = '<p class="text-muted mb-0">No alternate IDs</p>';
            }

            // Store current channel info for merge
            window.currentChannelInfo = {
                portal: row.portal,
                channelId: row.channelId,
                channelName: row.customChannelName || row.channelName
            };

            // Reset merge search
            document.getElementById('mergeChannelSearch').value = '';
            document.getElementById('mergeTargetPortal').value = '';
            document.getElementById('mergeTargetChannelId').value = '';
            document.getElementById('mergeChannelBtn').disabled = true;
            document.getElementById('mergeSearchResults').style.display = 'none';

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('channelInfoModal'));
            modal.show();
        } catch (error) {
            console.error('Error showing channel info:', error);
            showNotification('Error loading channel details', 'error');
        }
    }

    // Merge channel search functionality
    let mergeSearchTimeout = null;
    document.getElementById('mergeChannelSearch').addEventListener('input', function(e) {
        const query = e.target.value.trim();
        const resultsContainer = document.getElementById('mergeSearchResults');

        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        clearTimeout(mergeSearchTimeout);
        mergeSearchTimeout = setTimeout(async () => {
            // Search via API (since DataTable uses server-side pagination)
            resultsContainer.innerHTML = '<div class="list-group-item text-muted"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
            resultsContainer.style.display = 'block';

            try {
                const response = await fetch('/api/editor/search-for-merge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        portal: window.currentChannelInfo.portal,
                        excludeChannelId: window.currentChannelInfo.channelId,
                        query: query
                    })
                });

                const data = await response.json();

                if (data.success && data.channels.length > 0) {
                    let html = '';
                    data.channels.forEach(ch => {
                        const displayName = ch.customName || ch.name;
                        html += '<a href="#" class="list-group-item list-group-item-action merge-result-item" ' +
                                'data-portal="' + window.currentChannelInfo.portal + '" data-channel-id="' + ch.channelId + '">' +
                                '<small class="text-muted">ID: ' + ch.channelId + '</small> - ' + displayName +
                                (ch.genre ? ' <span class="badge bg-secondary">' + ch.genre + '</span>' : '') +
                                '</a>';
                    });
                    resultsContainer.innerHTML = html;
                } else {
                    resultsContainer.innerHTML = '<div class="list-group-item text-muted">No matching channels found</div>';
                }
            } catch (error) {
                console.error('Error searching channels:', error);
                resultsContainer.innerHTML = '<div class="list-group-item text-danger">Error searching channels</div>';
            }
        }, 300);
    });

    // Handle merge result selection
    document.getElementById('mergeSearchResults').addEventListener('click', function(e) {
        e.preventDefault();
        const item = e.target.closest('.merge-result-item');
        if (item) {
            const portal = item.dataset.portal;
            const channelId = item.dataset.channelId;
            const displayText = item.textContent;

            document.getElementById('mergeChannelSearch').value = displayText;
            document.getElementById('mergeTargetPortal').value = portal;
            document.getElementById('mergeTargetChannelId').value = channelId;
            document.getElementById('mergeChannelBtn').disabled = false;
            document.getElementById('mergeSearchResults').style.display = 'none';
        }
    });

    // Merge button click handler
    document.getElementById('mergeChannelBtn').addEventListener('click', function() {
        const secondaryPortal = document.getElementById('mergeTargetPortal').value;
        const secondaryChannelId = document.getElementById('mergeTargetChannelId').value;

        if (!secondaryPortal || !secondaryChannelId) {
            showNotification('Please select a channel to merge', 'warning');
            return;
        }

        if (!window.currentChannelInfo) {
            showNotification('Error: Current channel info not found', 'error');
            return;
        }

        const primaryPortal = window.currentChannelInfo.portal;
        const primaryChannelId = window.currentChannelInfo.channelId;

        if (primaryChannelId === secondaryChannelId) {
            showNotification('Cannot merge a channel with itself', 'warning');
            return;
        }

        // Confirm merge
        if (!confirm('Merge channel ID ' + secondaryChannelId + ' into ' + primaryChannelId + '?\n\n' +
                     'The secondary channel will be deleted and its ID will become an alternate for the primary channel.')) {
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Merging...';

        fetch('/api/editor/merge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                primaryPortal: primaryPortal,
                primaryChannelId: primaryChannelId,
                secondaryPortal: secondaryPortal,
                secondaryChannelId: secondaryChannelId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success', 5000);
                // Close modal and refresh table
                bootstrap.Modal.getInstance(document.getElementById('channelInfoModal')).hide();
                $('#channelsTable').DataTable().ajax.reload(null, false);
            } else {
                showNotification('Merge failed: ' + data.error, 'error', 5000);
            }
        })
        .catch(error => {
            showNotification('Error merging channels: ' + error, 'error', 5000);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-object-group"></i> Merge';
        });
    });

</script>
{% endblock %} 