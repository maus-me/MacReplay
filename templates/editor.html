{% extends "base.html" %}

{% block content %}
<div id="page-meta" data-page="editor"></div>
<script id="page-data" type="application/json">
{{ {"editorDataUrl": url_for("editor.editor_data"), "editorRefreshUrl": url_for("editor.editorRefresh")} | tojson }}
</script>
<datalist id="epg-suggestions"></datalist>

<div class="container-fluid p-lg-5">
    <!-- Filter Controls -->
    <div class="card mb-3 filter-card">
        <div class="card-body py-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="portalFilter" class="form-label small mb-1">Portal</label>
                    <select id="portalFilter" multiple placeholder="All Portals...">
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="groupFilter" class="form-label small mb-1">Group</label>
                    <select id="groupFilter" multiple placeholder="All Groups...">
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchFilter" class="form-label small mb-1">Search</label>
                    <input type="search" id="searchFilter" class="form-control" placeholder="Filter channels...">
                </div>
            </div>
            <div class="row g-3 align-items-end mt-1">
                <div class="col-md-6">
                    <label for="countryFilter" class="form-label small mb-1">Country</label>
                    <select id="countryFilter" multiple placeholder="All Countries..."></select>
                </div>
                <div class="col-md-6">
                    <label for="eventTagFilter" class="form-label small mb-1">Event Tags</label>
                    <select id="eventTagFilter" multiple placeholder="All Event Tags..."></select>
                </div>
            </div>
            <div class="row g-3 align-items-end mt-1">
                <div class="col-md-12">
                    <div class="filter-tag-groups">
                        <div class="filter-tag-box">
                            <label class="form-label small mb-1">Resolution</label>
                            <div id="resolutionButtons" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        <div class="filter-tag-box">
                            <label class="form-label small mb-1">Misc</label>
                            <div id="miscButtons" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        <div class="filter-tag-box">
                            <label class="form-label small mb-1">Flags</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm tri-toggle" data-key="hevc" data-state="off">HEVC</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm tri-toggle" data-key="raw" data-state="off">RAW</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm tri-toggle" data-key="event" data-state="off">EVENT</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm tri-toggle" data-key="match" data-state="off">MATCH</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm tri-toggle" data-key="header" data-state="off">HEADER</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm tri-toggle" data-key="epg" data-state="off">EPG</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="editor-table-wrap">
        <table id="table" class="table table-striped nowrap" width="100%">
        <thead>
            <tr>
                <th>
                    <div class="form-check form-switch">
                        <input type="checkbox" class="checkbox form-check-input" onchange="editAll(this)">
                    </div>
                </th>
                <th>Preview</th>
                <th>Nr</th>
                <th>Name</th>
                <th>Group</th>
                <th>Portal</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        </tbody>
        </table>
    </div>

    <form action="/editor/save" method="post" id="save-edits" hidden>
        <input type="text" id="enabledEdits" name="enabledEdits" value="">
        <input type="text" id="numberEdits" name="numberEdits" value="">
        <input type="text" id="nameEdits" name="nameEdits" value="">
        <input type="text" id="groupEdits" name="groupEdits" value="">
        <input type="text" id="epgEdits" name="epgEdits" value="">
    </form>

    <form action="/editor/reset" method="post" id="reset" hidden>
    </form>

    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="channelLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="channelLabel">Channel</h5>
                </div>
                <div class="modal-body">
                    <video width="100%" id="player" controls autoplay>
                        <source src="" type="video/mp4">
                        Your browser does not support HTML video.
                    </video>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Confirm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-start">
                        <div class="confirm-icon me-3" id="confirmModalIcon">
                            <i class="fas fa-question-circle fa-2x text-warning"></i>
                        </div>
                        <div>
                            <p class="mb-0" id="confirmModalMessage">Are you sure?</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="confirmModalOk">
                        <i class="fas fa-check"></i> <span id="confirmModalOkText">OK</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Channel Info Modal -->
    <div class="modal fade" id="channelInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        <span id="channelInfoTitle">Channel Details</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Logo -->
                        <div class="col-12 mb-3 text-center" id="channelInfoLogoContainer" style="display: none;">
                            <img id="channelInfoLogo" src="" alt="Channel Logo" style="max-height: 80px; max-width: 200px;">
                        </div>

                        <!-- Basic Info -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-tv me-2"></i>Channel Info</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Channel ID</th><td><code id="infoChannelId"></code></td></tr>
                                <tr><th>Name</th><td id="infoName"></td></tr>
                                <tr><th>Auto Name</th><td id="infoAutoName"></td></tr>
                                <tr><th>Custom Name</th><td id="infoCustomName"></td></tr>
                                <tr><th>Number</th><td id="infoNumber"></td></tr>
                                <tr><th>Custom Number</th><td id="infoCustomNumber"></td></tr>
                                <tr><th>Enabled</th><td id="infoEnabled"></td></tr>
                            </table>
                        </div>

                        <!-- Group/Genre Info -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-folder me-2"></i>Group Info</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Genre</th><td id="infoGenre"></td></tr>
                                <tr><th>Genre ID</th><td><code id="infoGenreId"></code></td></tr>
                                <tr><th>Custom Genre</th><td id="infoCustomGenre"></td></tr>
                                <tr><th>Portal</th><td id="infoPortalName"></td></tr>
                                <tr><th>Portal ID</th><td><code id="infoPortalId" style="font-size: 0.75em;"></code></td></tr>
                            </table>
                        </div>

                        <!-- EPG & Fallback -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-calendar me-2"></i>EPG & Fallback</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Has EPG</th><td id="infoHasEpg"></td></tr>
                                <tr><th>Custom EPG ID</th><td id="infoCustomEpgId"></td></tr>
                                <tr><th>Duplicates</th><td id="infoDuplicates"></td></tr>
                            </table>
                        </div>

                        <!-- Tag Info -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-tags me-2"></i>Tags</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Resolution</th><td id="infoResolution"></td></tr>
                                <tr><th>Video Codec</th><td id="infoVideoCodec"></td></tr>
                                <tr><th>Event Tags</th><td id="infoEventTags"></td></tr>
                                <tr><th>Misc Tags</th><td id="infoMiscTags"></td></tr>
                                <tr><th>Country</th><td id="infoCountry"></td></tr>
                                <tr><th>Matched Name</th><td id="infoMatchedName"></td></tr>
                                <tr><th>Matched Source</th><td id="infoMatchedSource"></td></tr>
                                <tr><th>RAW</th><td id="infoIsRaw"></td></tr>
                                <tr><th>Event</th><td id="infoIsEvent"></td></tr>
                                <tr><th>Header</th><td id="infoIsHeader"></td></tr>
                            </table>
                        </div>

                        <!-- Stream URL -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-link me-2"></i>Stream</h6>
                            <table class="table table-sm">
                                <tr><th style="width: 40%">Play URL</th><td><code id="infoLink" style="font-size: 0.7em; word-break: break-all;"></code></td></tr>
                            </table>
                        </div>

                        <!-- Alternate IDs -->
                        <div class="col-md-6 mt-3">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-code-branch me-2"></i>Alternate IDs</h6>
                            <div id="infoAlternateIds">
                                <p class="text-muted">No alternate IDs</p>
                            </div>
                        </div>

                        <!-- Available MACs -->
                        <div class="col-md-6 mt-3">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-network-wired me-2"></i>Available MACs</h6>
                            <div id="infoMacsContainer">
                                <p class="text-muted">No MACs available</p>
                            </div>
                        </div>

                        <!-- Merge Section -->
                        <div class="col-12 mt-3">
                            <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-object-group me-2"></i>Merge Duplicate</h6>
                            <p class="small text-muted mb-2">
                                Merge another channel into this one. The other channel's ID becomes an alternate ID,
                                and the system will try it as fallback if the primary ID fails.
                            </p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="mergeChannelSearch"
                                       placeholder="Search for channel to merge..." autocomplete="off">
                                <button class="btn btn-warning" type="button" id="mergeChannelBtn" disabled>
                                    <i class="fas fa-object-group"></i> Merge
                                </button>
                            </div>
                            <div id="mergeSearchResults" class="list-group mt-1" style="max-height: 150px; overflow-y: auto; display: none;"></div>
                            <input type="hidden" id="mergeTargetPortal" value="">
                            <input type="hidden" id="mergeTargetChannelId" value="">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Match Modal -->
    <div class="modal fade" id="manualMatchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-magic text-success me-2"></i>
                        Manual Match
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Channel</label>
                        <div class="manual-match-channel" id="manualMatchChannel">-</div>
                    </div>
                    <div class="mb-3">
                        <label for="manualMatchSearch" class="form-label">Search name</label>
                        <input type="text" class="form-control" id="manualMatchSearch" placeholder="Type to search ChannelsDVR...">
                    </div>
                    <div class="manual-match-results" id="manualMatchResults">
                        <div class="text-muted">No suggestions yet.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}{% endblock %}
 
