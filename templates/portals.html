{% extends "base.html" %}

{% block title %}Portals - MacReplay{% endblock %}


{% block content %}
<div id="page-meta" data-page="portals"></div>
<script id="page-data" type="application/json">
{{ {"portals": portals, "settings": settings} | tojson }}
</script>
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2><i class="fas fa-satellite-dish"></i> Portal Management</h2>
                <p class="text-muted mb-0">Manage your IPTV portals and MAC addresses</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div class="btn-group view-toggle" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="cardViewBtn" onclick="setView('card')" title="Card View">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="listViewBtn" onclick="setView('list')" title="List View">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPortalModal">
                    <i class="fas fa-plus"></i> Add Portal
                </button>
            </div>
        </div>
    </div>
</div>

{% if portals %}
<!-- Card View -->
<div class="portal-card-view" id="cardView">
    <div class="row">
        {% for portal_id, portal in portals.items() %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 portal-card" data-portal-id="{{ portal_id }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ portal.name or 'Unnamed Portal' }}</h5>
                    <div class="d-flex align-items-center gap-1">
                        <span class="badge bg-{{ 'success' if portal.get('fetch epg', True) else 'danger' }}" title="EPG {{ 'enabled' if portal.get('fetch epg', True) else 'disabled' }}">EPG</span>
                        <span class="badge bg-{{ 'success' if portal.get('auto match', False) else 'danger' }}" title="Matching {{ 'enabled' if portal.get('auto match', False) else 'disabled' }}">Match</span>
                        <span class="badge bg-{{ 'success' if portal.get('enabled', True) else 'danger' }}">
                            {{ 'Enabled' if portal.get('enabled', True) else 'Disabled' }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong>URL:</strong><br>
                        <small class="text-muted">{{ portal.url[:50] }}{% if portal.url|length > 50 %}...{% endif %}</small>
                    </p>
                    <div class="row mb-2">
                        <div class="col-6 card-stat-channels">
                            <strong><i class="fas fa-tv"></i> Channels:</strong>
                            {% set total_ch = portal_stats.get(portal_id, {}).get('total_channels', 0) %}
                            {% set selected_ch = portal_stats.get(portal_id, {}).get('channels', 0) %}
                            {% if total_ch > 0 and total_ch != selected_ch %}
                                <span class="text-primary">{{ selected_ch }}</span> / {{ total_ch }}
                            {% else %}
                                {{ selected_ch }}
                            {% endif %}
                        </div>
                        <div class="col-6 card-stat-groups">
                            <strong><i class="fas fa-folder"></i> Groups:</strong>
                            {% set active_groups = portal_stats.get(portal_id, {}).get('groups', 0) %}
                            {% set total_groups = portal_stats.get(portal_id, {}).get('total_groups', 0) %}
                            {% if total_groups > 0 and total_groups != active_groups %}
                                <span class="text-primary">{{ active_groups }}</span> / {{ total_groups }}
                            {% else %}
                                {{ active_groups }}
                            {% endif %}
                        </div>
                    </div>
                    <p class="card-text">
                        <strong>MAC Addresses:</strong> {{ portal.macs|length }}
                    </p>
                    <p class="card-text">
                        <strong>Streams per MAC:</strong> {{ portal['streams per mac'] }}
                    </p>
                    <p class="card-text mb-0">
                        <strong>EPG Offset:</strong> {{ portal['epg offset'] }} hours
                    </p>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <div>
                        <button class="btn btn-sm btn-outline-primary" data-action="edit" data-portal-id="{{ portal_id }}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="openGenreModal('{{ portal_id }}')">
                            <i class="fas fa-folder"></i> Groups
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshPortalChannels('{{ portal_id }}')" title="Refresh Channels">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" data-action="delete" data-portal-id="{{ portal_id }}" data-portal-name="{{ portal.name | e }}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- List View -->
<div class="portal-list-view" id="listView">
    <div class="portal-list">
        {% for portal_id, portal in portals.items() %}
        <div class="portal-list-item" data-portal-id="{{ portal_id }}">
            <div class="portal-header" onclick="togglePortal('{{ portal_id }}')">
                <i class="fas fa-chevron-right expand-icon"></i>
                <div class="portal-name-container">
                    <span class="portal-name">{{ portal.name or 'Unnamed Portal' }}</span>
                    <span class="portal-url-small">{{ portal.url[:60] }}{% if portal.url|length > 60 %}...{% endif %}</span>
                </div>
                <div class="portal-meta">
                    <span class="portal-meta-item portal-stat-channels" title="Total Channels">
                        <i class="fas fa-tv"></i>
                        <span class="portal-meta-value">{{ portal_stats.get(portal_id, {}).get('total_channels', portal_stats.get(portal_id, {}).get('channels', 0)) }}</span>
                    </span>
                    <span class="portal-meta-item portal-stat-groups" title="Total Groups">
                        <i class="fas fa-folder"></i>
                        <span class="portal-meta-value">{{ portal_stats.get(portal_id, {}).get('total_groups', portal_stats.get(portal_id, {}).get('groups', 0)) }}</span>
                    </span>
                    <span class="portal-meta-item portal-stat-macs" title="MACs">
                        <i class="fas fa-network-wired"></i>
                        <span class="portal-meta-value">{{ portal.macs|length }}</span>
                    </span>
                    <span class="portal-meta-item portal-stat-expiry" title="Days until next MAC expires" data-portal-id="{{ portal_id }}">
                        <i class="fas fa-clock"></i>
                        <span class="portal-expiry-value">-</span>
                    </span>
                    <span class="badge bg-{{ 'success' if portal.get('fetch epg', True) else 'danger' }}" title="EPG {{ 'enabled' if portal.get('fetch epg', True) else 'disabled' }}">EPG</span>
                    <span class="badge bg-{{ 'success' if portal.get('auto match', False) else 'danger' }}" title="Matching {{ 'enabled' if portal.get('auto match', False) else 'disabled' }}">Match</span>
                    <span class="badge bg-{{ 'success' if portal.get('enabled', True) else 'danger' }}">
                        {{ 'Enabled' if portal.get('enabled', True) else 'Disabled' }}
                    </span>
                </div>
                <div class="portal-actions">
                    <button class="btn btn-outline-primary" onclick="event.stopPropagation(); editPortal('{{ portal_id }}')" title="Edit Portal">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="event.stopPropagation(); openGenreModal('{{ portal_id }}')" title="Manage Groups">
                        <i class="fas fa-folder"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="event.stopPropagation(); refreshPortalChannels('{{ portal_id }}')" title="Refresh Channels">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="event.stopPropagation(); deletePortal('{{ portal_id }}', '{{ portal.name | e }}')" title="Delete Portal">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="portal-details">
                <div class="portal-info-grid">
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">Channels</div>
                        <div class="portal-info-value-large">
                            {% set total_ch = portal_stats.get(portal_id, {}).get('total_channels', 0) %}
                            {% set selected_ch = portal_stats.get(portal_id, {}).get('channels', 0) %}
                            {% if total_ch > 0 and total_ch != selected_ch %}
                                <span class="text-primary">{{ selected_ch }}</span><span class="text-muted"> / {{ total_ch }}</span>
                            {% else %}
                                <span class="text-primary">{{ selected_ch }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">Groups</div>
                        <div class="portal-info-value-large">
                            {% set active_groups = portal_stats.get(portal_id, {}).get('groups', 0) %}
                            {% set total_groups = portal_stats.get(portal_id, {}).get('total_groups', 0) %}
                            {% if total_groups > 0 and total_groups != active_groups %}
                                <span class="text-primary">{{ active_groups }}</span><span class="text-muted"> / {{ total_groups }}</span>
                            {% else %}
                                <span class="text-primary">{{ active_groups }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">Streams/MAC</div>
                        <div class="portal-info-value-large">{{ portal['streams per mac'] }}</div>
                    </div>
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">EPG Offset</div>
                        <div class="portal-info-value-large">{{ portal['epg offset'] }}h</div>
                    </div>
                    {% if portal.proxy %}
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">Proxy</div>
                        <div class="portal-info-value">{{ portal.proxy }}</div>
                    </div>
                    {% endif %}
                </div>

                <div class="mac-section-header d-flex justify-content-between align-items-center">
                    <span class="mac-section-title">
                        <i class="fas fa-list"></i> MAC Addresses ({{ portal.macs|length }})
                    </span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshPortalMacs('{{ portal_id }}')" title="Refresh MAC data">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                {% if portal.macs %}
                <table class="mac-table">
                    <thead>
                        <tr>
                            <th>MAC Address</th>
                            <th>Expires</th>
                            <th style="width: 70px;">Days Left</th>
                            <th style="width: 80px;">Watchdog</th>
                            <th style="width: 80px;">Max Streams</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mac, mac_data in portal.macs.items() %}
                        {# Unterst√ºtze sowohl altes Format (String) als auch neues Format (Dict) #}
                        {% if mac_data is mapping %}
                            {% set expiry = mac_data.expiry %}
                            {% set watchdog = mac_data.watchdog_timeout|default(0) %}
                            {% set playback = mac_data.playback_limit|default(0) %}
                        {% else %}
                            {% set expiry = mac_data %}
                            {% set watchdog = 0 %}
                            {% set playback = 0 %}
                        {% endif %}
                        <tr data-mac="{{ mac }}">
                            <td class="mac-address">{{ mac }}</td>
                            <td class="mac-expiry" data-expiry="{{ expiry }}">{{ expiry }}</td>
                            <td class="mac-days-left" data-expiry="{{ expiry }}"></td>
                            <td class="mac-watchdog" data-watchdog="{{ watchdog }}">
                                <span class="watchdog-badge"></span>
                            </td>
                            <td class="mac-playback-limit">{{ playback if playback > 0 else '-' }}</td>
                            <td>
                                <button class="btn btn-outline-danger btn-delete-mac"
                                        onclick="deleteMac('{{ portal_id }}', '{{ mac }}')"
                                        title="Delete MAC">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="no-macs">
                    <i class="fas fa-network-wired fa-2x mb-2"></i>
                    <p>No MAC addresses configured</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> No portals configured. Add your first portal to get started.
</div>
{% endif %}

<!-- Add Portal Modal -->
<div class="modal fade" id="addPortalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="/portal/add" id="addPortalForm">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Portal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_name" class="form-label">Portal Name</label>
                        <input type="text" class="form-control" id="add_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="add_url" class="form-label">Portal URL</label>
                        <input type="url" class="form-control" id="add_url" name="url" placeholder="http://portal.example.com" required>
                        <div class="form-text">Enter the portal domain or full URL</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_macs" class="form-label">MAC Addresses</label>
                        <textarea class="form-control" id="add_macs" name="macs" rows="3" placeholder="00:1A:79:XX:XX:XX,00:1A:79:YY:YY:YY" required></textarea>
                        <div class="form-text">Enter MAC addresses separated by commas</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="add_streams_per_mac" class="form-label">Streams per MAC</label>
                            <input type="number" class="form-control" id="add_streams_per_mac" name="streams per mac" value="1" min="0" max="10">
                        </div>
                        <div class="col-md-6">
                            <label for="add_epg_offset" class="form-label">EPG Offset (hours)</label>
                            <input type="number" class="form-control" id="add_epg_offset" name="epg offset" value="0" min="-12" max="12">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="add_proxy" class="form-label">Proxy (Optional)</label>
                        <input type="text" class="form-control" id="add_proxy" name="proxy" placeholder="http://proxy:port">
                        <div class="form-text">Leave empty if no proxy needed</div>
                    </div>
                    <div class="mb-3 d-flex flex-wrap gap-2">
                        <input type="checkbox" class="btn-check" id="add_fetch_epg" name="fetch epg" value="true" checked autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="add_fetch_epg">Fetch EPG</label>

                        <input type="checkbox" class="btn-check" id="add_auto_normalize" name="auto normalize names" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="add_auto_normalize">Auto Normalize</label>

                        <input type="checkbox" class="btn-check" id="add_auto_match" name="auto match" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="add_auto_match">Auto Match</label>
                    </div>
                    <div class="alert alert-secondary">
                        <i class="fas fa-info-circle"></i> After adding the portal, use the <strong>Groups</strong> button to select which groups to import.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Portal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Portal Modal -->
<div class="modal fade" id="editPortalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="/portal/update" id="editPortalForm">
                <input type="hidden" id="edit_portal_id" name="id">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Portal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_enabled" name="enabled" value="true">
                            <label class="form-check-label" for="edit_enabled">
                                Portal Enabled
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Portal Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_url" class="form-label">Portal URL</label>
                        <input type="url" class="form-control" id="edit_url" name="url" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_macs" class="form-label">MAC Addresses</label>
                        <textarea class="form-control" id="edit_macs" name="macs" rows="3" required></textarea>
                        <div class="form-text">Enter MAC addresses separated by commas</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="edit_streams_per_mac" class="form-label">Streams per MAC</label>
                            <input type="number" class="form-control" id="edit_streams_per_mac" name="streams per mac" min="0" max="10">
                        </div>
                        <div class="col-md-6">
                            <label for="edit_epg_offset" class="form-label">EPG Offset (hours)</label>
                            <input type="number" class="form-control" id="edit_epg_offset" name="epg offset" min="-12" max="12">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="edit_proxy" class="form-label">Proxy (Optional)</label>
                        <input type="text" class="form-control" id="edit_proxy" name="proxy">
                    </div>
                    <div class="mb-3 d-flex flex-wrap gap-2">
                        <input type="checkbox" class="btn-check" id="edit_fetch_epg" name="fetch epg" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="edit_fetch_epg">Fetch EPG</label>

                        <input type="checkbox" class="btn-check" id="edit_auto_normalize" name="auto normalize names" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="edit_auto_normalize">Auto Normalize</label>

                        <input type="checkbox" class="btn-check" id="edit_auto_match" name="auto match" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="edit_auto_match">Auto Match</label>

                        <input type="checkbox" class="btn-check" id="retest" name="retest" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="retest">Retest MACs</label>
                    </div>

                    <div class="alert alert-secondary mt-3">
                        <i class="fas fa-info-circle"></i> Use the <strong>Groups</strong> button in the portal list to manage which groups to import.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Portal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Portal Modal -->
<div class="modal fade" id="deletePortalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/portal/remove">
                <input type="hidden" id="delete_portal_id" name="deleteId">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the portal "<span id="delete_portal_name"></span>"?</p>
                    <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Portal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete MAC Confirmation Modal -->
<div class="modal fade" id="deleteMacModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete MAC</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Delete MAC address:</p>
                <p class="mac-address text-center" id="delete_mac_address"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger btn-sm" onclick="confirmMacDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Genre/Groups Management Modal -->
<div class="modal fade" id="genreModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder"></i> Manage Groups - <span id="genreModalPortalName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> Select which groups to import. Deselecting a group will remove its channels. Leave all unchecked to import all channels.
                </div>

                <div id="genreModalLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading groups from portal...</p>
                </div>

                <div id="genreModalContent" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary" onclick="selectAllModalGenres()">
                                <i class="fas fa-check-double"></i> All
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="applyDefaultGroupSelection()">
                                <i class="fas fa-magic"></i> Lade Standarts
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="deselectAllModalGenres()">
                                <i class="fas fa-times"></i> None
                            </button>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted" id="genreModalStats"></span>
                            <div class="genre-search-container">
                                <input type="text" class="form-control" id="genreModalSearchInput"
                                       placeholder="Search groups..." oninput="filterModalGenres()">
                            </div>
                        </div>
                    </div>
                    <div id="genreModalTilesContainer" class="genre-tiles-grid genre-tiles-large">
                        <!-- Genre tiles populated by JavaScript -->
                    </div>
                </div>

                <div id="genreModalError" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> <span id="genreModalErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGenresBtn" onclick="savePortalGenres()">
                    <i class="fas fa-save"></i> Save & Refresh
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}{% endblock %}
