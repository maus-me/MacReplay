{% extends "base.html" %}

{% block title %}Portals - MacReplay{% endblock %}


{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2><i class="fas fa-satellite-dish"></i> Portal Management</h2>
                <p class="text-muted mb-0">Manage your IPTV portals and MAC addresses</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div class="btn-group view-toggle" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="cardViewBtn" onclick="setView('card')" title="Card View">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="listViewBtn" onclick="setView('list')" title="List View">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPortalModal">
                    <i class="fas fa-plus"></i> Add Portal
                </button>
            </div>
        </div>
    </div>
</div>

{% if portals %}
<!-- Card View -->
<div class="portal-card-view" id="cardView">
    <div class="row">
        {% for portal_id, portal in portals.items() %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 portal-card" data-portal-id="{{ portal_id }}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ portal.name or 'Unnamed Portal' }}</h5>
                    <div class="d-flex align-items-center gap-1">
                        <span class="badge bg-{{ 'success' if portal.get('fetch epg', 'true') == 'true' else 'danger' }}" title="EPG {{ 'enabled' if portal.get('fetch epg', 'true') == 'true' else 'disabled' }}">EPG</span>
                        <span class="badge bg-{{ 'success' if portal.get('auto match', 'false') == 'true' else 'danger' }}" title="Matching {{ 'enabled' if portal.get('auto match', 'false') == 'true' else 'disabled' }}">Match</span>
                        <span class="badge bg-{{ 'success' if portal.enabled == 'true' else 'danger' }}">
                            {{ 'Enabled' if portal.enabled == 'true' else 'Disabled' }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong>URL:</strong><br>
                        <small class="text-muted">{{ portal.url[:50] }}{% if portal.url|length > 50 %}...{% endif %}</small>
                    </p>
                    <div class="row mb-2">
                        <div class="col-6 card-stat-channels">
                            <strong><i class="fas fa-tv"></i> Channels:</strong>
                            {% set total_ch = portal_stats.get(portal_id, {}).get('total_channels', 0) %}
                            {% set selected_ch = portal_stats.get(portal_id, {}).get('channels', 0) %}
                            {% if total_ch > 0 and total_ch != selected_ch %}
                                <span class="text-primary">{{ selected_ch }}</span> / {{ total_ch }}
                            {% else %}
                                {{ selected_ch }}
                            {% endif %}
                        </div>
                        <div class="col-6 card-stat-groups">
                            <strong><i class="fas fa-folder"></i> Groups:</strong>
                            {% set active_groups = portal_stats.get(portal_id, {}).get('groups', 0) %}
                            {% set total_groups = portal_stats.get(portal_id, {}).get('total_groups', 0) %}
                            {% if total_groups > 0 and total_groups != active_groups %}
                                <span class="text-primary">{{ active_groups }}</span> / {{ total_groups }}
                            {% else %}
                                {{ active_groups }}
                            {% endif %}
                        </div>
                    </div>
                    <p class="card-text">
                        <strong>MAC Addresses:</strong> {{ portal.macs|length }}
                    </p>
                    <p class="card-text">
                        <strong>Streams per MAC:</strong> {{ portal['streams per mac'] }}
                    </p>
                    <p class="card-text mb-0">
                        <strong>EPG Offset:</strong> {{ portal['epg offset'] }} hours
                    </p>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <div>
                        <button class="btn btn-sm btn-outline-primary" data-action="edit" data-portal-id="{{ portal_id }}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="openGenreModal('{{ portal_id }}')">
                            <i class="fas fa-folder"></i> Groups
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshPortalChannels('{{ portal_id }}')" title="Refresh Channels">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" data-action="delete" data-portal-id="{{ portal_id }}" data-portal-name="{{ portal.name | e }}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- List View -->
<div class="portal-list-view" id="listView">
    <div class="portal-list">
        {% for portal_id, portal in portals.items() %}
        <div class="portal-list-item" data-portal-id="{{ portal_id }}">
            <div class="portal-header" onclick="togglePortal('{{ portal_id }}')">
                <i class="fas fa-chevron-right expand-icon"></i>
                <div class="portal-name-container">
                    <span class="portal-name">{{ portal.name or 'Unnamed Portal' }}</span>
                    <span class="portal-url-small">{{ portal.url[:60] }}{% if portal.url|length > 60 %}...{% endif %}</span>
                </div>
                <div class="portal-meta">
                    <span class="portal-meta-item portal-stat-channels" title="Total Channels">
                        <i class="fas fa-tv"></i>
                        <span class="portal-meta-value">{{ portal_stats.get(portal_id, {}).get('total_channels', portal_stats.get(portal_id, {}).get('channels', 0)) }}</span>
                    </span>
                    <span class="portal-meta-item portal-stat-groups" title="Total Groups">
                        <i class="fas fa-folder"></i>
                        <span class="portal-meta-value">{{ portal_stats.get(portal_id, {}).get('total_groups', portal_stats.get(portal_id, {}).get('groups', 0)) }}</span>
                    </span>
                    <span class="portal-meta-item portal-stat-macs" title="MACs">
                        <i class="fas fa-network-wired"></i>
                        <span class="portal-meta-value">{{ portal.macs|length }}</span>
                    </span>
                    <span class="portal-meta-item portal-stat-expiry" title="Days until next MAC expires" data-portal-id="{{ portal_id }}">
                        <i class="fas fa-clock"></i>
                        <span class="portal-expiry-value">-</span>
                    </span>
                    <span class="badge bg-{{ 'success' if portal.get('fetch epg', 'true') == 'true' else 'danger' }}" title="EPG {{ 'enabled' if portal.get('fetch epg', 'true') == 'true' else 'disabled' }}">EPG</span>
                    <span class="badge bg-{{ 'success' if portal.get('auto match', 'false') == 'true' else 'danger' }}" title="Matching {{ 'enabled' if portal.get('auto match', 'false') == 'true' else 'disabled' }}">Match</span>
                    <span class="badge bg-{{ 'success' if portal.enabled == 'true' else 'danger' }}">
                        {{ 'Enabled' if portal.enabled == 'true' else 'Disabled' }}
                    </span>
                </div>
                <div class="portal-actions">
                    <button class="btn btn-outline-primary" onclick="event.stopPropagation(); editPortal('{{ portal_id }}')" title="Edit Portal">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="event.stopPropagation(); openGenreModal('{{ portal_id }}')" title="Manage Groups">
                        <i class="fas fa-folder"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="event.stopPropagation(); refreshPortalChannels('{{ portal_id }}')" title="Refresh Channels">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="event.stopPropagation(); deletePortal('{{ portal_id }}', '{{ portal.name | e }}')" title="Delete Portal">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="portal-details">
                <div class="portal-info-grid">
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">Channels</div>
                        <div class="portal-info-value-large">
                            {% set total_ch = portal_stats.get(portal_id, {}).get('total_channels', 0) %}
                            {% set selected_ch = portal_stats.get(portal_id, {}).get('channels', 0) %}
                            {% if total_ch > 0 and total_ch != selected_ch %}
                                <span class="text-primary">{{ selected_ch }}</span><span class="text-muted"> / {{ total_ch }}</span>
                            {% else %}
                                <span class="text-primary">{{ selected_ch }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">Groups</div>
                        <div class="portal-info-value-large">
                            {% set active_groups = portal_stats.get(portal_id, {}).get('groups', 0) %}
                            {% set total_groups = portal_stats.get(portal_id, {}).get('total_groups', 0) %}
                            {% if total_groups > 0 and total_groups != active_groups %}
                                <span class="text-primary">{{ active_groups }}</span><span class="text-muted"> / {{ total_groups }}</span>
                            {% else %}
                                <span class="text-primary">{{ active_groups }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">Streams/MAC</div>
                        <div class="portal-info-value-large">{{ portal['streams per mac'] }}</div>
                    </div>
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">EPG Offset</div>
                        <div class="portal-info-value-large">{{ portal['epg offset'] }}h</div>
                    </div>
                    {% if portal.proxy %}
                    <div class="portal-info-item portal-info-tile">
                        <div class="portal-info-label">Proxy</div>
                        <div class="portal-info-value">{{ portal.proxy }}</div>
                    </div>
                    {% endif %}
                </div>

                <div class="mac-section-header d-flex justify-content-between align-items-center">
                    <span class="mac-section-title">
                        <i class="fas fa-list"></i> MAC Addresses ({{ portal.macs|length }})
                    </span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshPortalMacs('{{ portal_id }}')" title="Refresh MAC data">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                {% if portal.macs %}
                <table class="mac-table">
                    <thead>
                        <tr>
                            <th>MAC Address</th>
                            <th>Expires</th>
                            <th style="width: 70px;">Days Left</th>
                            <th style="width: 80px;">Watchdog</th>
                            <th style="width: 80px;">Max Streams</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mac, mac_data in portal.macs.items() %}
                        {# Unterstütze sowohl altes Format (String) als auch neues Format (Dict) #}
                        {% if mac_data is mapping %}
                            {% set expiry = mac_data.expiry %}
                            {% set watchdog = mac_data.watchdog_timeout|default(0) %}
                            {% set playback = mac_data.playback_limit|default(0) %}
                        {% else %}
                            {% set expiry = mac_data %}
                            {% set watchdog = 0 %}
                            {% set playback = 0 %}
                        {% endif %}
                        <tr data-mac="{{ mac }}">
                            <td class="mac-address">{{ mac }}</td>
                            <td class="mac-expiry" data-expiry="{{ expiry }}">{{ expiry }}</td>
                            <td class="mac-days-left" data-expiry="{{ expiry }}"></td>
                            <td class="mac-watchdog" data-watchdog="{{ watchdog }}">
                                <span class="watchdog-badge"></span>
                            </td>
                            <td class="mac-playback-limit">{{ playback if playback > 0 else '-' }}</td>
                            <td>
                                <button class="btn btn-outline-danger btn-delete-mac"
                                        onclick="deleteMac('{{ portal_id }}', '{{ mac }}')"
                                        title="Delete MAC">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="no-macs">
                    <i class="fas fa-network-wired fa-2x mb-2"></i>
                    <p>No MAC addresses configured</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> No portals configured. Add your first portal to get started.
</div>
{% endif %}

<!-- Add Portal Modal -->
<div class="modal fade" id="addPortalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="/portal/add" id="addPortalForm">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Portal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_name" class="form-label">Portal Name</label>
                        <input type="text" class="form-control" id="add_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="add_url" class="form-label">Portal URL</label>
                        <input type="url" class="form-control" id="add_url" name="url" placeholder="http://portal.example.com" required>
                        <div class="form-text">Enter the portal domain or full URL</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_macs" class="form-label">MAC Addresses</label>
                        <textarea class="form-control" id="add_macs" name="macs" rows="3" placeholder="00:1A:79:XX:XX:XX,00:1A:79:YY:YY:YY" required></textarea>
                        <div class="form-text">Enter MAC addresses separated by commas</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="add_streams_per_mac" class="form-label">Streams per MAC</label>
                            <input type="number" class="form-control" id="add_streams_per_mac" name="streams per mac" value="1" min="0" max="10">
                        </div>
                        <div class="col-md-6">
                            <label for="add_epg_offset" class="form-label">EPG Offset (hours)</label>
                            <input type="number" class="form-control" id="add_epg_offset" name="epg offset" value="0" min="-12" max="12">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="add_proxy" class="form-label">Proxy (Optional)</label>
                        <input type="text" class="form-control" id="add_proxy" name="proxy" placeholder="http://proxy:port">
                        <div class="form-text">Leave empty if no proxy needed</div>
                    </div>
                    <div class="mb-3 d-flex flex-wrap gap-2">
                        <input type="checkbox" class="btn-check" id="add_fetch_epg" name="fetch epg" value="true" checked autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="add_fetch_epg">Fetch EPG</label>

                        <input type="checkbox" class="btn-check" id="add_auto_normalize" name="auto normalize names" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="add_auto_normalize">Auto Normalize</label>

                        <input type="checkbox" class="btn-check" id="add_auto_match" name="auto match" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="add_auto_match">Auto Match</label>
                    </div>
                    <div class="alert alert-secondary">
                        <i class="fas fa-info-circle"></i> After adding the portal, use the <strong>Groups</strong> button to select which groups to import.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Portal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Portal Modal -->
<div class="modal fade" id="editPortalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="/portal/update" id="editPortalForm">
                <input type="hidden" id="edit_portal_id" name="id">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Portal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_enabled" name="enabled" value="true">
                            <label class="form-check-label" for="edit_enabled">
                                Portal Enabled
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Portal Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_url" class="form-label">Portal URL</label>
                        <input type="url" class="form-control" id="edit_url" name="url" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_macs" class="form-label">MAC Addresses</label>
                        <textarea class="form-control" id="edit_macs" name="macs" rows="3" required></textarea>
                        <div class="form-text">Enter MAC addresses separated by commas</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="edit_streams_per_mac" class="form-label">Streams per MAC</label>
                            <input type="number" class="form-control" id="edit_streams_per_mac" name="streams per mac" min="0" max="10">
                        </div>
                        <div class="col-md-6">
                            <label for="edit_epg_offset" class="form-label">EPG Offset (hours)</label>
                            <input type="number" class="form-control" id="edit_epg_offset" name="epg offset" min="-12" max="12">
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label for="edit_proxy" class="form-label">Proxy (Optional)</label>
                        <input type="text" class="form-control" id="edit_proxy" name="proxy">
                    </div>
                    <div class="mb-3 d-flex flex-wrap gap-2">
                        <input type="checkbox" class="btn-check" id="edit_fetch_epg" name="fetch epg" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="edit_fetch_epg">Fetch EPG</label>

                        <input type="checkbox" class="btn-check" id="edit_auto_normalize" name="auto normalize names" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="edit_auto_normalize">Auto Normalize</label>

                        <input type="checkbox" class="btn-check" id="edit_auto_match" name="auto match" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="edit_auto_match">Auto Match</label>

                        <input type="checkbox" class="btn-check" id="retest" name="retest" value="true" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="retest">Retest MACs</label>
                    </div>

                    <div class="alert alert-secondary mt-3">
                        <i class="fas fa-info-circle"></i> Use the <strong>Groups</strong> button in the portal list to manage which groups to import.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Portal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Portal Modal -->
<div class="modal fade" id="deletePortalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/portal/remove">
                <input type="hidden" id="delete_portal_id" name="deleteId">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the portal "<span id="delete_portal_name"></span>"?</p>
                    <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Portal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete MAC Confirmation Modal -->
<div class="modal fade" id="deleteMacModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete MAC</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Delete MAC address:</p>
                <p class="mac-address text-center" id="delete_mac_address"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger btn-sm" onclick="confirmMacDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Genre/Groups Management Modal -->
<div class="modal fade" id="genreModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder"></i> Manage Groups - <span id="genreModalPortalName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> Select which groups to import. Deselecting a group will remove its channels. Leave all unchecked to import all channels.
                </div>

                <div id="genreModalLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading groups from portal...</p>
                </div>

                <div id="genreModalContent" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-primary" onclick="selectAllModalGenres()">
                                <i class="fas fa-check-double"></i> All
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="applyDefaultGroupSelection()">
                                <i class="fas fa-magic"></i> Lade Standarts
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="deselectAllModalGenres()">
                                <i class="fas fa-times"></i> None
                            </button>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted" id="genreModalStats"></span>
                            <div class="genre-search-container">
                                <input type="text" class="form-control" id="genreModalSearchInput"
                                       placeholder="Search groups..." oninput="filterModalGenres()">
                            </div>
                        </div>
                    </div>
                    <div id="genreModalTilesContainer" class="genre-tiles-grid genre-tiles-large">
                        <!-- Genre tiles populated by JavaScript -->
                    </div>
                </div>

                <div id="genreModalError" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> <span id="genreModalErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveGenresBtn" onclick="savePortalGenres()">
                    <i class="fas fa-save"></i> Save & Refresh
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const portalsData = {{ portals | tojson }};
portalsData.__settings__ = {{ settings | tojson }};

// View toggle
function setView(view) {
    const cardView = document.getElementById('cardView');
    const listView = document.getElementById('listView');
    const cardBtn = document.getElementById('cardViewBtn');
    const listBtn = document.getElementById('listViewBtn');

    if (view === 'card') {
        cardView.classList.add('active');
        listView.classList.remove('active');
        cardBtn.classList.add('active');
        listBtn.classList.remove('active');
    } else {
        cardView.classList.remove('active');
        listView.classList.add('active');
        cardBtn.classList.remove('active');
        listBtn.classList.add('active');
    }

    localStorage.setItem('portalsView', view);
}

// Toggle portal expand/collapse (list view)
function togglePortal(portalId) {
    const item = document.querySelector(`.portal-list-item[data-portal-id="${portalId}"]`);
    if (item) {
        item.classList.toggle('expanded');
    }
}

// Edit portal
let currentEditPortalId = null;
let currentEditSelectedGenres = [];

function editPortal(portalId) {
    const portal = portalsData[portalId];
    if (!portal) return;

    currentEditPortalId = portalId;
    currentEditSelectedGenres = portal.selected_genres || [];

    document.getElementById('edit_portal_id').value = portalId;
    document.getElementById('edit_enabled').checked = portal.enabled === 'true';
    document.getElementById('edit_name').value = portal.name;
    document.getElementById('edit_url').value = portal.url;
    document.getElementById('edit_macs').value = Object.keys(portal.macs).join(',');
    document.getElementById('edit_streams_per_mac').value = portal['streams per mac'];
    document.getElementById('edit_epg_offset').value = portal['epg offset'];
    document.getElementById('edit_proxy').value = portal.proxy || '';
    document.getElementById('edit_fetch_epg').checked = (portal['fetch epg'] || 'true') === 'true';
    document.getElementById('edit_auto_normalize').checked = (portal['auto normalize names'] || 'false') === 'true';
    document.getElementById('edit_auto_match').checked = (portal['auto match'] || 'false') === 'true';

    new bootstrap.Modal(document.getElementById('editPortalModal')).show();
}

// Preserve selected_genres when updating portal
document.getElementById('editPortalForm')?.addEventListener('submit', function(e) {
    // Remove any existing hidden genre inputs
    this.querySelectorAll('input[name="selected_genres"]').forEach(el => el.remove());

    // Keep the original genre selection (genres are managed via separate modal)
    currentEditSelectedGenres.forEach(g => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_genres';
        input.value = g;
        this.appendChild(input);
    });
});

// Delete portal
function deletePortal(portalId, portalName) {
    document.getElementById('delete_portal_id').value = portalId;
    document.getElementById('delete_portal_name').textContent = portalName;
    new bootstrap.Modal(document.getElementById('deletePortalModal')).show();
}

// Delete individual MAC
let pendingMacDelete = { portalId: null, mac: null };

function deleteMac(portalId, mac) {
    pendingMacDelete = { portalId, mac };
    document.getElementById('delete_mac_address').textContent = mac;
    new bootstrap.Modal(document.getElementById('deleteMacModal')).show();
}

async function confirmMacDelete() {
    const { portalId, mac } = pendingMacDelete;
    if (!portalId || !mac) return;

    try {
        const response = await fetch('/api/portal/mac/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portal_id: portalId, mac: mac })
        });

        const data = await response.json();

        if (data.success) {
            // Remove the row from the table
            const row = document.querySelector(`tr[data-mac="${mac}"]`);
            if (row) {
                row.remove();
            }

            // Update MAC count in the header
            const item = document.querySelector(`.portal-list-item[data-portal-id="${portalId}"]`);
            if (item) {
                const countSpan = item.querySelector('.portal-meta-item span');
                const currentCount = parseInt(countSpan.textContent) - 1;
                countSpan.textContent = `${currentCount} MACs`;

                // Update section title
                const sectionTitle = item.querySelector('.mac-section-title');
                if (sectionTitle) {
                    sectionTitle.innerHTML = `<i class="fas fa-list"></i> MAC Addresses (${currentCount})`;
                }

                // Show "no macs" message if all deleted
                if (currentCount === 0) {
                    const tableWrapper = item.querySelector('.mac-table');
                    if (tableWrapper) {
                        tableWrapper.outerHTML = `
                            <div class="no-macs">
                                <i class="fas fa-network-wired fa-2x mb-2"></i>
                                <p>No MAC addresses configured</p>
                            </div>`;
                    }
                }
            }

            // Update local data
            if (portalsData[portalId] && portalsData[portalId].macs) {
                delete portalsData[portalId].macs[mac];
            }

            // Reload the page to reflect changes
            location.reload();
        } else {
            showToast('Error: ' + (data.message || 'Failed to delete MAC'), 'error');
        }
    } catch (error) {
        console.error('Error deleting MAC:', error);
        showToast('Error deleting MAC address', 'error');
    }

    bootstrap.Modal.getInstance(document.getElementById('deleteMacModal')).hide();
}

// Refresh MAC data for a portal
async function refreshPortalMacs(portalId) {
    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';

    try {
        const response = await fetch('/api/portal/macs/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portal_id: portalId })
        });

        const data = await response.json();

        if (data.success) {
            // Update local data and refresh table
            if (data.macs) {
                portalsData[portalId].macs = data.macs;
                updateMacTable(portalId, data.macs);
            }
            showToast(data.message, 'success');
        } else {
            showToast('Error: ' + (data.message || 'Failed to refresh MACs'), 'error');
        }
    } catch (error) {
        console.error('Error refreshing MACs:', error);
        showToast('Error refreshing MAC data', 'error');
    }

    btn.disabled = false;
    btn.innerHTML = originalContent;
}

// Update MAC table with new data
function updateMacTable(portalId, macs) {
    console.log('updateMacTable called for portal:', portalId, 'with macs:', macs);

    const portalItem = document.querySelector(`.portal-list-item[data-portal-id="${portalId}"]`);
    if (!portalItem) {
        console.error('Portal item not found for ID:', portalId);
        return;
    }

    const tbody = portalItem.querySelector('.mac-table tbody');
    if (!tbody) {
        console.error('MAC table tbody not found');
        return;
    }

    for (const [mac, macData] of Object.entries(macs)) {
        console.log('Processing MAC:', mac, 'Data:', macData);

        const row = tbody.querySelector(`tr[data-mac="${mac}"]`);
        if (!row) {
            console.warn('Row not found for MAC:', mac);
            continue;
        }

        const expiry = typeof macData === 'object' ? (macData.expiry || 'Unknown') : (macData || 'Unknown');
        const watchdog = typeof macData === 'object' ? (macData.watchdog_timeout || 0) : 0;
        const playback = typeof macData === 'object' ? (macData.playback_limit || 0) : 0;

        console.log('Updating row - expiry:', expiry, 'watchdog:', watchdog, 'playback:', playback);

        // Update expiry cell - both text and data attribute
        const expiryCell = row.querySelector('.mac-expiry');
        if (expiryCell) {
            expiryCell.textContent = expiry;
            expiryCell.setAttribute('data-expiry', expiry);
        }

        // Update days left cell - set data attribute for calculation
        const daysCell = row.querySelector('.mac-days-left');
        if (daysCell) {
            daysCell.setAttribute('data-expiry', expiry);
        }

        // Update watchdog cell
        const watchdogCell = row.querySelector('.mac-watchdog');
        if (watchdogCell) {
            watchdogCell.setAttribute('data-watchdog', watchdog);
        }

        // Update playback limit cell
        const playbackCell = row.querySelector('.mac-playback-limit');
        if (playbackCell) {
            playbackCell.textContent = playback > 0 ? playback : '-';
        }
    }

    // Re-calculate days left and watchdog badges
    console.log('Recalculating expiry highlights and watchdog badges');
    highlightExpiringMacs();
    formatWatchdogBadges();
}

// Parse date string like "March 2, 2026, 12:00 am" to Date object
function parseExpiryDate(dateStr) {
    if (!dateStr) return null;
    try {
        return new Date(dateStr);
    } catch (e) {
        return null;
    }
}

// Sort MAC tables by expiration date (earliest first)
function sortMacTablesByExpiry() {
    document.querySelectorAll('.mac-table tbody').forEach(tbody => {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            const expiryA = parseExpiryDate(a.querySelector('.mac-expiry')?.dataset.expiry);
            const expiryB = parseExpiryDate(b.querySelector('.mac-expiry')?.dataset.expiry);

            // Handle null dates (put them at the end)
            if (!expiryA && !expiryB) return 0;
            if (!expiryA) return 1;
            if (!expiryB) return -1;

            return expiryA - expiryB; // Earliest first
        });

        // Re-append sorted rows
        rows.forEach(row => tbody.appendChild(row));
    });
}

// Calculate remaining days and highlight MACs
function highlightExpiringMacs() {
    const now = new Date();
    const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
    const oneDay = 24 * 60 * 60 * 1000;
    const statusClasses = ['status-expired', 'status-expiring-soon', 'status-valid'];

    document.querySelectorAll('.mac-expiry').forEach(cell => {
        const expiryStr = cell.dataset.expiry;
        // Clear old status classes
        cell.classList.remove(...statusClasses);

        if (!expiryStr || expiryStr === 'Unknown') return;

        try {
            const expiry = new Date(expiryStr);
            if (isNaN(expiry.getTime())) return; // Invalid date

            if (expiry < now) {
                cell.classList.add('status-expired');
            } else if (expiry < thirtyDaysFromNow) {
                cell.classList.add('status-expiring-soon');
            } else {
                cell.classList.add('status-valid');
            }
        } catch (e) {
            // Invalid date format, skip
        }
    });

    // Calculate and display remaining days
    document.querySelectorAll('.mac-days-left').forEach(cell => {
        const expiryStr = cell.dataset.expiry;
        // Clear old status classes
        cell.classList.remove(...statusClasses);

        if (!expiryStr || expiryStr === 'Unknown') {
            cell.textContent = '-';
            return;
        }

        try {
            const expiry = new Date(expiryStr);
            if (isNaN(expiry.getTime())) {
                cell.textContent = '-';
                return;
            }

            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / oneDay);

            if (diffDays < 0) {
                cell.textContent = 'Expired';
                cell.classList.add('status-expired');
            } else if (diffDays === 0) {
                cell.textContent = 'Today';
                cell.classList.add('status-expiring-soon');
            } else if (diffDays === 1) {
                cell.textContent = '1 day';
                cell.classList.add('status-expiring-soon');
            } else if (diffDays <= 30) {
                cell.textContent = `${diffDays} days`;
                cell.classList.add('status-expiring-soon');
            } else {
                cell.textContent = `${diffDays} days`;
                cell.classList.add('status-valid');
            }
        } catch (e) {
            cell.textContent = '-';
        }
    });
}

// Format watchdog timeout badges with color coding
function formatWatchdogBadges() {
    document.querySelectorAll('.mac-watchdog').forEach(cell => {
        const watchdog = parseInt(cell.dataset.watchdog) || 0;
        const badge = cell.querySelector('.watchdog-badge');
        if (!badge) return;

        let text, colorClass, title;
        if (watchdog === 0) {
            // Keine Daten verfügbar
            text = '-';
            colorClass = 'bg-secondary';
            title = 'Keine Watchdog-Daten verfügbar';
        } else if (watchdog < 60) {
            // Sehr aktiv - rot
            text = `${watchdog}s`;
            colorClass = 'bg-danger';
            title = 'Sehr aktiv (< 60s) - MAC wird gerade genutzt';
        } else if (watchdog < 300) {
            // Aktiv - gelb
            const mins = Math.floor(watchdog / 60);
            text = `${mins}m`;
            colorClass = 'bg-warning text-dark';
            title = 'Aktiv (1-5 min) - Kürzlich genutzt';
        } else if (watchdog < 1800) {
            // Moderat - blau
            const mins = Math.floor(watchdog / 60);
            text = `${mins}m`;
            colorClass = 'bg-info';
            title = 'Moderate Aktivität (5-30 min)';
        } else {
            // Idle - grün
            const mins = Math.floor(watchdog / 60);
            text = mins >= 60 ? `${Math.floor(mins / 60)}h` : `${mins}m`;
            colorClass = 'bg-success';
            title = 'Idle (> 30 min) - Sicher zu benutzen';
        }

        badge.className = `watchdog-badge badge ${colorClass}`;
        badge.textContent = text;
        badge.title = title;
    });
}

// Calculate and display LATEST MAC expiry for each portal in list view
function updatePortalExpiryIndicators() {
    const now = new Date();
    const oneDay = 24 * 60 * 60 * 1000;

    document.querySelectorAll('.portal-stat-expiry').forEach(indicator => {
        const portalId = indicator.dataset.portalId;
        const portalItem = indicator.closest('.portal-list-item');
        if (!portalItem) return;

        const expiryDates = [];
        portalItem.querySelectorAll('.mac-expiry').forEach(cell => {
            const expiryStr = cell.dataset.expiry;
            if (expiryStr) {
                try {
                    expiryDates.push(new Date(expiryStr));
                } catch (e) {}
            }
        });

        const valueSpan = indicator.querySelector('.portal-expiry-value');
        if (expiryDates.length === 0) {
            valueSpan.textContent = '-';
            return;
        }

        // Find LATEST (last) expiry - maximum date
        const latest = expiryDates.reduce((max, d) => d > max ? d : max);
        const diffDays = Math.ceil((latest - now) / oneDay);

        if (diffDays < 0) {
            valueSpan.textContent = 'Exp!';
            valueSpan.classList.add('status-expired');
        } else if (diffDays === 0) {
            valueSpan.textContent = 'Today';
            valueSpan.classList.add('status-expiring-soon');
        } else if (diffDays <= 30) {
            valueSpan.textContent = `${diffDays}d`;
            valueSpan.classList.add('status-expiring-soon');
        } else {
            valueSpan.textContent = `${diffDays}d`;
            valueSpan.classList.add('status-valid');
        }
    });
}

// Event delegation for portal actions
document.addEventListener('click', function(e) {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;
    const portalId = btn.dataset.portalId;

    if (action === 'edit') {
        editPortal(portalId);
    } else if (action === 'delete') {
        deletePortal(portalId, btn.dataset.portalName);
    }
});

// ===== Genre Tile Helper =====
function toggleGenreTile(tile) {
    tile.classList.toggle('selected');
}

// ========== Channel Refresh Function ==========
async function refreshPortalChannels(portalId) {
    const portal = portalsData[portalId];
    const portalName = portal ? portal.name : portalId;

    // Find and disable the refresh button, show spinner
    const buttons = document.querySelectorAll(`button[onclick*="refreshPortalChannels('${portalId}')"]`);
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    });

    showToast(`Refreshing channels for "${portalName}"...`, 'info');

    try {
        const response = await fetch('/api/portal/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portal_id: portalId })
        });

        const data = await response.json();

        if (data.status === 'queued') {
            showToast('Refresh queued. It will run after the current one finishes.', 'info');
            pollRefreshStatus(portalId);
        } else if (data.status === 'running') {
            showToast('Refresh already running. Please wait...', 'warning');
            pollRefreshStatus(portalId);
        } else if (data.status === 'completed') {
            if (data.stats) {
                showToast(`${data.stats.channels} channels loaded for "${data.portal}"`, 'success');
                updatePortalStats(portalId, data.stats);
            } else {
                showToast(`Refresh completed for "${portalName}"`, 'success');
            }
        } else {
            showToast('Error: ' + (data.message || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error refreshing channels: ' + error, 'error');
    } finally {
        // Re-enable buttons
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync"></i>';
        });
    }
}

function pollRefreshStatus(portalId) {
    const startedAt = Date.now();
    const poll = () => {
        fetch('/api/portal/refresh/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portal_id: portalId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'completed') {
                    if (data.stats) {
                        showToast(`Refresh completed: ${data.stats.channels} channels`, 'success');
                        updatePortalStats(portalId, data.stats);
                    } else {
                        showToast('Refresh completed.', 'success');
                    }
                    return;
                }
                if (data.status === 'error') {
                    showToast(`Refresh failed: ${data.error || 'Unknown error'}`, 'error');
                    return;
                }
                if (Date.now() - startedAt < 300000) {
                    setTimeout(poll, 2000);
                }
            })
            .catch(() => {
                if (Date.now() - startedAt < 300000) {
                    setTimeout(poll, 3000);
                }
            });
    };
    setTimeout(poll, 1500);
}

function updatePortalStats(portalId, stats) {
    // Update card view stats
    const cardItem = document.querySelector(`.portal-card[data-portal-id="${portalId}"]`);
    if (cardItem) {
        // Update channels display
        const channelCol = cardItem.querySelector('.card-stat-channels');
        if (channelCol) {
            if (stats.total_channels > 0 && stats.total_channels !== stats.channels) {
                channelCol.innerHTML = `<strong><i class="fas fa-tv"></i> Channels:</strong>
                    <span class="text-primary">${stats.channels}</span> / ${stats.total_channels}`;
            } else {
                channelCol.innerHTML = `<strong><i class="fas fa-tv"></i> Channels:</strong> ${stats.channels}`;
            }
        }

        // Update groups display
        const groupCol = cardItem.querySelector('.card-stat-groups');
        if (groupCol) {
            if (stats.total_groups > 0 && stats.total_groups !== stats.groups) {
                groupCol.innerHTML = `<strong><i class="fas fa-folder"></i> Groups:</strong>
                    <span class="text-primary">${stats.groups}</span> / ${stats.total_groups}`;
            } else {
                groupCol.innerHTML = `<strong><i class="fas fa-folder"></i> Groups:</strong> ${stats.groups}`;
            }
        }
    }

    // Update list view stats
    const listItem = document.querySelector(`.portal-list-item[data-portal-id="${portalId}"]`);
    if (listItem) {
        // Update header meta (total channels/groups)
        const channelMeta = listItem.querySelector('.portal-stat-channels .portal-meta-value');
        if (channelMeta) channelMeta.textContent = stats.total_channels;

        const groupMeta = listItem.querySelector('.portal-stat-groups .portal-meta-value');
        if (groupMeta) groupMeta.textContent = stats.total_groups;

        // Update details tiles
        const channelTile = listItem.querySelector('.portal-info-tile:nth-child(1) .portal-info-value-large');
        if (channelTile) {
            if (stats.total_channels > 0 && stats.total_channels !== stats.channels) {
                channelTile.innerHTML = `<span class="text-primary">${stats.channels}</span><span class="text-muted"> / ${stats.total_channels}</span>`;
            } else {
                channelTile.innerHTML = `<span class="text-primary">${stats.channels}</span>`;
            }
        }

        const groupTile = listItem.querySelector('.portal-info-tile:nth-child(2) .portal-info-value-large');
        if (groupTile) {
            if (stats.total_groups > 0 && stats.total_groups !== stats.groups) {
                groupTile.innerHTML = `<span class="text-primary">${stats.groups}</span><span class="text-muted"> / ${stats.total_groups}</span>`;
            } else {
                groupTile.innerHTML = `<span class="text-primary">${stats.groups}</span>`;
            }
        }
    }
}

// ========== Standalone Genre Modal Functions ==========
let currentGenreModalPortalId = null;
let currentGenreModalMac = null;  // MAC used to fetch genres
let genreModalGenres = [];

async function openGenreModal(portalId) {
    currentGenreModalPortalId = portalId;
    const portal = portalsData[portalId];

    if (!portal) {
        showToast('Portal not found', 'error');
        return;
    }

    // Set modal title
    document.getElementById('genreModalPortalName').textContent = portal.name || 'Unnamed Portal';

    // Reset modal state
    document.getElementById('genreModalLoading').style.display = 'block';
    document.getElementById('genreModalContent').style.display = 'none';
    document.getElementById('genreModalError').style.display = 'none';
    document.getElementById('genreModalSearchInput').value = '';
    document.getElementById('genreModalTilesContainer').innerHTML = '';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('genreModal'));
    modal.show();

    // First try to load groups from database (fast)
    try {
        const dbResponse = await fetch('/api/portal/groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portal_id: portalId })
        });

        const dbData = await dbResponse.json();

        if (dbData.success && dbData.groups && dbData.groups.length > 0) {
            // Groups found in database - use active flag for selection
            document.getElementById('genreModalLoading').style.display = 'none';
            genreModalGenres = dbData.groups.map(g => ({
                id: g.id,
                title: g.title,
                channel_count: g.channel_count
            }));
            if (!genreModalGenres.find(g => String(g.id) === 'UNGROUPED')) {
                genreModalGenres.unshift({ id: 'UNGROUPED', title: 'Ungrouped', channel_count: 0 });
            }
            const activeGenreIds = dbData.groups.filter(g => g.active).map(g => g.id);
            renderGenreModalTiles(genreModalGenres, activeGenreIds);
            updateGenreModalStats();
            document.getElementById('genreModalContent').style.display = 'block';
            return;
        }
    } catch (dbError) {
        console.log('Could not load groups from DB, falling back to portal API:', dbError);
    }

    // Fallback: Fetch genres from portal API (for new portals without channels yet)
    try {
        const firstMac = Object.keys(portal.macs)[0];
        currentGenreModalMac = firstMac;
        const response = await fetch('/api/portal/genres', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: portal.url,
                mac: firstMac,
                proxy: portal.proxy || ''
            })
        });

        const data = await response.json();
        document.getElementById('genreModalLoading').style.display = 'none';

        if (data.success && data.genres && data.genres.length > 0) {
            genreModalGenres = data.genres;
            if (!genreModalGenres.find(g => String(g.id) === 'UNGROUPED')) {
                genreModalGenres.unshift({ id: 'UNGROUPED', title: 'Ungrouped', channel_count: 0 });
            }
            renderGenreModalTiles(data.genres, portal.selected_genres || []);
            updateGenreModalStats();
            document.getElementById('genreModalContent').style.display = 'block';
        } else {
            document.getElementById('genreModalErrorMessage').textContent =
                data.message || 'No groups available from this portal';
            document.getElementById('genreModalError').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('genreModalLoading').style.display = 'none';
        document.getElementById('genreModalErrorMessage').textContent = 'Error fetching groups: ' + error;
        document.getElementById('genreModalError').style.display = 'block';
    }
}

function renderGenreModalTiles(genres, selectedGenres) {
    const container = document.getElementById('genreModalTilesContainer');
    const totalChannels = genres.reduce((sum, g) => sum + (g.channel_count || 0), 0);

    const ensured = [...genres];
    if (!ensured.find(g => String(g.id) === 'UNGROUPED')) {
        ensured.unshift({ id: 'UNGROUPED', title: 'Ungrouped', channel_count: 0 });
    }
    container.innerHTML = ensured.map(g => {
        const isSelected = selectedGenres.length === 0 || selectedGenres.includes(g.id);
        return `
            <div class="genre-tile ${isSelected ? 'selected' : ''}"
                 data-genre-id="${g.id}" data-genre-title="${g.title}"
                 onclick="toggleGenreTile(this); updateGenreModalStats();">
                <div class="genre-tile-title">${g.title}</div>
                <div class="genre-tile-count">${g.channel_count || 0}</div>
                <div class="genre-tile-label">Channels</div>
            </div>
        `;
    }).join('');
}

function updateGenreModalStats() {
    const selectedTiles = document.querySelectorAll('#genreModalTilesContainer .genre-tile.selected');
    const totalTiles = document.querySelectorAll('#genreModalTilesContainer .genre-tile');

    let selectedChannels = 0;
    selectedTiles.forEach(tile => {
        const genreId = tile.dataset.genreId;
        const genre = genreModalGenres.find(g => g.id === genreId);
        if (genre) selectedChannels += (genre.channel_count || 0);
    });

    const totalChannels = genreModalGenres.reduce((sum, g) => sum + (g.channel_count || 0), 0);

    document.getElementById('genreModalStats').innerHTML =
        `<strong>${selectedTiles.length}</strong> / ${totalTiles.length} groups selected · ` +
        `<strong>${selectedChannels}</strong> / ${totalChannels} channels`;
}

function selectAllModalGenres() {
    document.querySelectorAll('#genreModalTilesContainer .genre-tile:not([style*="display: none"])').forEach(tile => {
        tile.classList.add('selected');
    });
    updateGenreModalStats();
}

function deselectAllModalGenres() {
    document.querySelectorAll('#genreModalTilesContainer .genre-tile').forEach(tile => {
        tile.classList.remove('selected');
    });
    updateGenreModalStats();
}

function applyDefaultGroupSelection() {
    const patternsRaw = (portalsData.__settings__ && portalsData.__settings__["auto group selection patterns"]) || "";
    const patterns = patternsRaw.split(/\r?\n/).map(p => p.trim()).filter(Boolean);
    if (!patterns.length) {
        showToast('Keine Standard-Patterns gesetzt (Settings).', 'warning');
        return;
    }
    document.querySelectorAll('#genreModalTilesContainer .genre-tile').forEach(tile => {
        const title = tile.dataset.genreTitle || '';
        let matched = false;
        for (const pattern of patterns) {
            try {
                if (new RegExp(pattern, 'i').test(title)) {
                    matched = true;
                    break;
                }
            } catch (e) {
                if (title.toLowerCase().includes(pattern.toLowerCase())) {
                    matched = true;
                    break;
                }
            }
        }
        tile.classList.toggle('selected', matched);
    });
    updateGenreModalStats();
}

function filterModalGenres() {
    const searchTerm = document.getElementById('genreModalSearchInput').value.toLowerCase();
    document.querySelectorAll('#genreModalTilesContainer .genre-tile').forEach(tile => {
        const title = tile.dataset.genreTitle;
        tile.style.display = title.includes(searchTerm) ? '' : 'none';
    });
}

async function savePortalGenres() {
    const allTiles = document.querySelectorAll('#genreModalTilesContainer .genre-tile');
    const selectedGenres = Array.from(document.querySelectorAll('#genreModalTilesContainer .genre-tile.selected'))
        .map(tile => tile.dataset.genreId);

    // Calculate total channels from all genres
    const totalChannels = genreModalGenres.reduce((sum, g) => sum + (g.channel_count || 0), 0);

    const btn = document.getElementById('saveGenresBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving & Refreshing...';

    try {
        const response = await fetch('/api/portal/genres/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                portal_id: currentGenreModalPortalId,
                selected_genres: selectedGenres,
                total_groups: allTiles.length,
                total_channels: totalChannels,
                genres_mac: currentGenreModalMac  // MAC used for genre selection
            })
        });

        const data = await response.json();

        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('genreModal')).hide();

            // Update stats dynamically without page reload
            updatePortalStats(currentGenreModalPortalId, {
                total_channels: data.total_channels,
                channels: data.active_channels,
                total_groups: data.total_groups,
                groups: data.active_groups
            });

            showToast(`Groups updated: ${data.active_groups}/${data.total_groups} groups, ${data.active_channels}/${data.total_channels} channels`, 'success');
            if (data.match_started) {
                pollMatchStatus(currentGenreModalPortalId);
            }
            if (data.refresh_status === 'queued') {
                showToast('Channel refresh queued.', 'info');
                pollRefreshStatus(currentGenreModalPortalId);
            } else if (data.refresh_status === 'running') {
                showToast('Channel refresh already running.', 'warning');
                pollRefreshStatus(currentGenreModalPortalId);
            }
        } else {
            showToast('Error saving groups: ' + (data.message || 'Unknown error'), 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Save';
        }
    } catch (error) {
        showToast('Error saving groups: ' + error, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Save';
    }
}

function pollMatchStatus(portalId) {
    const startedAt = Date.now();
    const poll = () => {
        fetch('/api/portal/match/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ portal_id: portalId })
        })
            .then(res => res.json())
            .then(data => {
                if (!data.success) return;
                if (data.status === 'completed') {
                    showToast(`Matching completed: ${data.matched} channels`, 'success');
                    return;
                }
                if (data.status === 'error') {
                    showToast(`Matching failed: ${data.error || 'Unknown error'}`, 'error');
                    return;
                }
                if (Date.now() - startedAt < 300000) {
                    setTimeout(poll, 2000);
                }
            })
            .catch(() => {
                if (Date.now() - startedAt < 300000) {
                    setTimeout(poll, 3000);
                }
            });
    };
    setTimeout(poll, 1500);
}

// Reset genre modal when closed
document.getElementById('genreModal')?.addEventListener('hidden.bs.modal', function() {
    currentGenreModalPortalId = null;
    currentGenreModalMac = null;
    genreModalGenres = [];
    document.getElementById('genreModalTilesContainer').innerHTML = '';
    document.getElementById('genreModalSearchInput').value = '';

    // Reset save button state
    const btn = document.getElementById('saveGenresBtn');
    if (btn) {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Save & Refresh';
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load saved view preference
    const savedView = localStorage.getItem('portalsView') || 'card';
    setView(savedView);

    // Sort MACs by expiration date (earliest first)
    sortMacTablesByExpiry();

    // Highlight expiring MACs
    highlightExpiringMacs();

    // Format watchdog badges
    formatWatchdogBadges();

    // Update portal expiry indicators in list view
    updatePortalExpiryIndicators();
});
</script>
{% endblock %}
