{% extends "base.html" %}

{% block title %}Settings - MacReplay{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-cog"></i> Settings</h2>
        <p class="text-muted">Configure MacReplay application settings</p>
    </div>
</div>

<form method="POST" action="/settings/save">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-video"></i> Streaming Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="stream_method" class="form-label">Stream Method</label>
                        <select class="form-select" id="stream_method" name="stream method">
                            <option value="ffmpeg" {{ 'selected' if settings['stream method'] == 'ffmpeg' }}>FFmpeg</option>
                            <option value="redirect" {{ 'selected' if settings['stream method'] == 'redirect' }}>Direct Redirect</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="output_format" class="form-label">Output Format</label>
                        <select class="form-select" id="output_format" name="output format">
                            <option value="mpegts" {{ 'selected' if settings['output format'] == 'mpegts' }}>MPEG-TS (pipe) - Current behavior</option>
                            <option value="hls" {{ 'selected' if settings['output format'] == 'hls' }}>HLS (segmented) - Instant start on Plex/Apple TV</option>
                        </select>
                        <div class="form-text">
                            HLS is recommended for Plex/Apple TV (faster start, consumes disk space for segments).
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="hls_segment_type" class="form-label">HLS Segment Type</label>
                        <select class="form-select" id="hls_segment_type" name="hls segment type">
                            <option value="fmp4" {{ 'selected' if settings['hls segment type'] == 'fmp4' }}>fMP4 - Best for Plex (recommended)</option>
                            <option value="mpegts" {{ 'selected' if settings['hls segment type'] == 'mpegts' }}>MPEG-TS - Better compatibility</option>
                        </select>
                        <div class="form-text">
                            fMP4 provides better Plex compatibility and faster startup. Only applies when Output Format is HLS.
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hls_segment_duration" class="form-label">HLS Segment Duration (seconds)</label>
                                <input type="number" class="form-control" id="hls_segment_duration" name="hls segment duration" 
                                       value="{{ settings['hls segment duration'] }}" min="2" max="10">
                                <div class="form-text">
                                    Lower = faster start, more CPU. Recommended: 4 seconds.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="hls_playlist_size" class="form-label">HLS Playlist Size (segments)</label>
                                <input type="number" class="form-control" id="hls_playlist_size" name="hls playlist size" 
                                       value="{{ settings['hls playlist size'] }}" min="3" max="20">
                                <div class="form-text">
                                    Number of segments to keep. Recommended: 6.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ffmpeg_command" class="form-label">FFmpeg Command (MPEG-TS only)</label>
                        <textarea class="form-control" id="ffmpeg_command" name="ffmpeg command" rows="3">{{ settings['ffmpeg command'] }}</textarea>
                        <div class="form-text">
                            Use placeholders: &lt;url&gt;, &lt;proxy&gt;, &lt;timeout&gt;. Only used when Output Format is MPEG-TS.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ffmpeg_timeout" class="form-label">FFmpeg Timeout (seconds)</label>
                        <input type="number" class="form-control" id="ffmpeg_timeout" name="ffmpeg timeout" 
                               value="{{ settings['ffmpeg timeout'] }}" min="1" max="60">
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="test_streams" name="test streams" 
                               value="true" {{ 'checked' if settings['test streams'] }}>
                        <label class="form-check-label" for="test_streams">
                            Test streams before serving
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="try_all_macs" name="try all macs"
                               value="true" {{ 'checked' if settings['try all macs'] }}>
                        <label class="form-check-label" for="try_all_macs">
                            Try all MAC addresses on failure
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="parallel_mac_probing" name="parallel mac probing"
                               value="true" {{ 'checked' if settings['parallel mac probing'] }}>
                        <label class="form-check-label" for="parallel_mac_probing">
                            Parallel MAC probing
                        </label>
                        <div class="form-text">
                            Test multiple MAC addresses simultaneously for faster channel lookup.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="parallel_mac_workers" class="form-label">Parallel Workers</label>
                        <input type="number" class="form-control" id="parallel_mac_workers" name="parallel mac workers"
                               value="{{ settings['parallel mac workers'] }}" min="2" max="10">
                        <div class="form-text">
                            Number of MACs to test in parallel. Higher = faster but more server load.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Playlist Settings</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="use_channel_genres" name="use channel genres" 
                               value="true" {{ 'checked' if settings['use channel genres'] }}>
                        <label class="form-check-label" for="use_channel_genres">
                            Include channel genres in playlist
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="use_channel_numbers" name="use channel numbers" 
                               value="true" {{ 'checked' if settings['use channel numbers'] }}>
                        <label class="form-check-label" for="use_channel_numbers">
                            Include channel numbers in playlist
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sort_by_genre" name="sort playlist by channel genre" 
                               value="true" {{ 'checked' if settings['sort playlist by channel genre'] }}>
                        <label class="form-check-label" for="sort_by_genre">
                            Sort playlist by genre
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sort_by_number" name="sort playlist by channel number" 
                               value="true" {{ 'checked' if settings['sort playlist by channel number'] }}>
                        <label class="form-check-label" for="sort_by_number">
                            Sort playlist by channel number
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sort_by_name" name="sort playlist by channel name"
                               value="true" {{ 'checked' if settings['sort playlist by channel name'] }}>
                        <label class="form-check-label" for="sort_by_name">
                            Sort playlist by channel name
                        </label>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-calendar-alt"></i> EPG Settings</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="epg_refresh_interval" class="form-label">EPG Refresh Interval (hours)</label>
                                <input type="number" class="form-control" id="epg_refresh_interval" name="epg refresh interval"
                                       value="{{ settings['epg refresh interval'] }}" min="0.25" max="24" step="0.25">
                                <div class="form-text">
                                    How often to refresh EPG data. Default: 0.5h.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="channel_refresh_interval" class="form-label">Channel Refresh Interval (hours)</label>
                                <input type="number" class="form-control" id="channel_refresh_interval" name="channel refresh interval"
                                       value="{{ settings['channel refresh interval'] }}" min="0" max="168" step="1">
                                <div class="form-text">
                                    How often to refresh channels from portals. 0 = disabled. Default: 24h.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="epg_future_hours" class="form-label">EPG Future (hours)</label>
                                <input type="number" class="form-control" id="epg_future_hours" name="epg future hours"
                                       value="{{ settings['epg future hours'] }}" min="1" max="168" step="1">
                                <div class="form-text">
                                    How far into the future to fetch EPG data. Default: 24 hours.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="epg_past_hours" class="form-label">EPG Past (hours)</label>
                                <input type="number" class="form-control" id="epg_past_hours" name="epg past hours"
                                       value="{{ settings['epg past hours'] }}" min="0" max="48" step="1">
                                <div class="form-text">
                                    How far into the past to keep EPG data. Default: 2 hours.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-satellite-dish"></i> EPG Sources</h5>
                    <button type="button" class="btn btn-outline-success btn-sm" id="addEpgSourceBtn">
                        <i class="fas fa-plus"></i> Add Source
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Add external XMLTV sources. These are merged into the generated EPG and can be assigned manually per channel.
                    </p>
                    <div id="epgSourcesList" class="epg-sources-list"></div>
                    <input type="hidden" id="epgSourcesInput" name="epg custom sources" value='{{ settings["epg custom sources"] | tojson }}'>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tags"></i> Tag Extraction</h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="resetTagDefaults">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="tag_country_codes" class="form-label">Country Codes (CSV)</label>
                        <textarea class="form-control" id="tag_country_codes" name="tag country codes" rows="2">{{ settings['tag country codes'] }}</textarea>
                    </div>
                    <div class="mb-3 tag-rule-group" data-textarea="tag_resolution_patterns" data-format="label">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <label class="form-label mb-0">Resolution Patterns</label>
                            <div class="tag-rule-actions">
                                <button type="button" class="btn btn-sm btn-outline-success tag-rule-add">
                                    <i class="fas fa-plus"></i> Add Rule
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary tag-rule-toggle-raw">
                                    Raw
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger tag-rule-clear">
                                    Clear
                                </button>
                            </div>
                        </div>
                        <div class="form-text">Format: LABEL = REGEX</div>
                        <div class="tag-rule-list"></div>
                        <div class="tag-rule-raw d-none">
                            <textarea class="form-control tag-rule-textarea" id="tag_resolution_patterns" name="tag resolution patterns" rows="5">{{ settings['tag resolution patterns'] }}</textarea>
                        </div>
                    </div>
                    <div class="mb-3 tag-rule-group" data-textarea="tag_event_patterns" data-format="line">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <label class="form-label mb-0">Event Patterns</label>
                            <div class="tag-rule-actions">
                                <button type="button" class="btn btn-sm btn-outline-success tag-rule-add">
                                    <i class="fas fa-plus"></i> Add Rule
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary tag-rule-toggle-raw">
                                    Raw
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger tag-rule-clear">
                                    Clear
                                </button>
                            </div>
                        </div>
                        <div class="form-text">One regex per line.</div>
                        <div class="tag-rule-list"></div>
                        <div class="tag-rule-raw d-none">
                            <textarea class="form-control tag-rule-textarea" id="tag_event_patterns" name="tag event patterns" rows="4">{{ settings['tag event patterns'] }}</textarea>
                        </div>
                    </div>
                    <div class="mb-3 tag-rule-group" data-textarea="tag_misc_patterns" data-format="line">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <label class="form-label mb-0">Misc Patterns</label>
                            <div class="tag-rule-actions">
                                <button type="button" class="btn btn-sm btn-outline-success tag-rule-add">
                                    <i class="fas fa-plus"></i> Add Rule
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary tag-rule-toggle-raw">
                                    Raw
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger tag-rule-clear">
                                    Clear
                                </button>
                            </div>
                        </div>
                        <div class="form-text">One regex per line.</div>
                        <div class="tag-rule-list"></div>
                        <div class="tag-rule-raw d-none">
                            <textarea class="form-control tag-rule-textarea" id="tag_misc_patterns" name="tag misc patterns" rows="3">{{ settings['tag misc patterns'] }}</textarea>
                        </div>
                    </div>
                    <div class="mb-3 tag-rule-group" data-textarea="tag_header_patterns" data-format="line">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <label class="form-label mb-0">Header Patterns</label>
                            <div class="tag-rule-actions">
                                <button type="button" class="btn btn-sm btn-outline-success tag-rule-add">
                                    <i class="fas fa-plus"></i> Add Rule
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary tag-rule-toggle-raw">
                                    Raw
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger tag-rule-clear">
                                    Clear
                                </button>
                            </div>
                        </div>
                        <div class="form-text">Applied before the decoration heuristic.</div>
                        <div class="tag-rule-list"></div>
                        <div class="tag-rule-raw d-none">
                            <textarea class="form-control tag-rule-textarea" id="tag_header_patterns" name="tag header patterns" rows="3">{{ settings['tag header patterns'] }}</textarea>
                        </div>
                    </div>

                    <div class="border-top pt-3 mt-3">
                        <h6 class="mb-3"><i class="fas fa-database"></i> ChannelsDVR Matching</h6>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="channelsdvr_enabled" name="channelsdvr enabled"
                                   value="true" {{ 'checked' if settings['channelsdvr enabled'] }}>
                            <label class="form-check-label" for="channelsdvr_enabled">
                                Use ChannelsDVR DB to protect channel names
                            </label>
                        </div>
                        <div class="mb-3">
                            <label for="channelsdvr_db_path" class="form-label">ChannelsDVR DB Path</label>
                            <input type="text" class="form-control" id="channelsdvr_db_path" name="channelsdvr db path"
                                   value="{{ settings['channelsdvr db path'] }}">
                        </div>
                        <div class="mb-3">
                            <label for="channelsdvr_match_threshold" class="form-label">Match Threshold (0-1)</label>
                            <input type="number" step="0.01" min="0.5" max="0.99" class="form-control" id="channelsdvr_match_threshold"
                                   name="channelsdvr match threshold" value="{{ settings['channelsdvr match threshold'] }}">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="channelsdvr_debug" name="channelsdvr debug"
                                   value="true" {{ 'checked' if settings['channelsdvr debug'] }}>
                            <label class="form-check-label" for="channelsdvr_debug">
                                Enable debug logging for ChannelsDVR matching
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="channelsdvr_include_lineup_channels" name="channelsdvr include lineup channels"
                                   value="true" {{ 'checked' if settings['channelsdvr include lineup channels'] }}>
                            <label class="form-check-label" for="channelsdvr_include_lineup_channels">
                                Include lineup channel names (slower, broader matches)
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="channelsdvr_cache_enabled" name="channelsdvr cache enabled"
                                   value="true" {{ 'checked' if settings['channelsdvr cache enabled'] }}>
                            <label class="form-check-label" for="channelsdvr_cache_enabled">
                                Cache ChannelsDVR names on disk
                            </label>
                        </div>
                        <div class="mb-3">
                            <label for="channelsdvr_cache_dir" class="form-label">Cache Directory</label>
                            <input type="text" class="form-control" id="channelsdvr_cache_dir" name="channelsdvr cache dir"
                                   value="{{ settings['channelsdvr cache dir'] }}">
                        </div>
                        <div class="form-text">
                            Uses country code from channel name to narrow ChannelsDVR lookup.
                        </div>
                    </div>

                    <div class="border-top pt-3 mt-3">
                        <h6 class="mb-3"><i class="fas fa-filter"></i> Auto Group Selection</h6>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="auto_group_selection_enabled" name="auto group selection enabled"
                                   value="true" {{ 'checked' if settings['auto group selection enabled'] }}>
                            <label class="form-check-label" for="auto_group_selection_enabled">
                                Auto-select groups when none are selected yet
                            </label>
                        </div>
                        <div class="mb-3">
                            <label for="auto_group_selection_patterns" class="form-label">Group Match Patterns (one per line)</label>
                            <textarea class="form-control" id="auto_group_selection_patterns" name="auto group selection patterns" rows="4">{{ settings['auto group selection patterns'] }}</textarea>
                            <div class="form-text">Examples: ^DE\\b, ^US\\b, Bundesliga, NFL, NHL. Regex supported.</div>
                        </div>
                    </div>

                    <div class="border-top pt-3 mt-3">
                        <h6 class="mb-3"><i class="fas fa-broom"></i> Database Maintenance</h6>
                        <p class="text-muted mb-3">
                            Schedule and run database maintenance tasks for Channels and EPG databases.
                        </p>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label for="vacuum_channels_interval" class="form-label">Vacuum Channels DB Interval (hours, 0=disabled)</label>
                                <input type="number" class="form-control" id="vacuum_channels_interval" name="vacuum channels interval hours"
                                       value="{{ settings['vacuum channels interval hours'] }}" min="0" step="0.5">
                            </div>
                            <div class="col-md-6">
                                <label for="vacuum_epg_interval" class="form-label">Vacuum EPG DB Interval (hours, 0=disabled)</label>
                                <input type="number" class="form-control" id="vacuum_epg_interval" name="vacuum epg interval hours"
                                       value="{{ settings['vacuum epg interval hours'] }}" min="0" step="0.5">
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="vacuumChannelsNow">
                                <i class="fas fa-database"></i> Vacuum Channels DB
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="vacuumEpgNow">
                                <i class="fas fa-database"></i> Vacuum EPG DBs
                            </button>
                        </div>
                        <div class="form-text mt-2" id="dbCleanupStatus"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-shield-alt"></i> Security Settings</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="enable_security" name="enable security" 
                               value="true" {{ 'checked' if settings['enable security'] }}>
                        <label class="form-check-label" for="enable_security">
                            Enable HTTP authentication
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" 
                               value="{{ settings['username'] }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" 
                               value="{{ settings['password'] }}" required>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tv"></i> HDHR Settings</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="enable_hdhr" name="enable hdhr" 
                               value="true" {{ 'checked' if settings['enable hdhr'] }}>
                        <label class="form-check-label" for="enable_hdhr">
                            Enable HD HomeRun emulation
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="hdhr_name" class="form-label">HDHR Device Name</label>
                        <input type="text" class="form-control" id="hdhr_name" name="hdhr name" 
                               value="{{ settings['hdhr name'] }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="hdhr_id" class="form-label">HDHR Device ID</label>
                        <input type="text" class="form-control" id="hdhr_id" name="hdhr id" 
                               value="{{ settings['hdhr id'] }}" readonly>
                        <div class="form-text">Device ID is automatically generated</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="hdhr_tuners" class="form-label">Number of Tuners</label>
                        <input type="number" class="form-control" id="hdhr_tuners" name="hdhr tuners" 
                               value="{{ settings['hdhr tuners'] }}" min="1" max="20">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Settings
            </button>
        </div>
    </div>
</form>

<div class="modal fade" id="epgSourceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">EPG Source</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="epgSourceId">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label" for="epgSourceName">Name</label>
                        <input type="text" class="form-control" id="epgSourceName" placeholder="e.g. XMLTV Provider">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="epgSourceInterval">Update Interval (hours)</label>
                        <input type="number" class="form-control" id="epgSourceInterval" min="0.25" step="0.25" value="24">
                    </div>
                    <div class="col-12">
                        <label class="form-label" for="epgSourceUrl">XMLTV URL</label>
                        <input type="url" class="form-control" id="epgSourceUrl" placeholder="https://example.com/xmltv.xml">
                    </div>
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="epgSourceEnabled" checked>
                            <label class="form-check-label" for="epgSourceEnabled">
                                Enabled
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEpgSourceBtn">Save Source</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Confirm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-start">
                    <div class="confirm-icon me-3" id="confirmModalIcon">
                        <i class="fas fa-question-circle fa-2x text-warning"></i>
                    </div>
                    <div>
                        <p class="mb-0" id="confirmModalMessage">Are you sure?</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmModalOk">
                    <i class="fas fa-check"></i> <span id="confirmModalOkText">OK</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        function showConfirmDialog(options) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmModalTitle');
                const messageEl = document.getElementById('confirmModalMessage');
                const iconEl = document.getElementById('confirmModalIcon');
                const okBtn = document.getElementById('confirmModalOk');
                const okTextEl = document.getElementById('confirmModalOkText');

                titleEl.textContent = options.title || 'Confirm';
                messageEl.textContent = options.message || 'Are you sure?';
                okTextEl.textContent = options.okText || 'OK';

                const type = options.type || 'warning';
                if (type === 'danger') {
                    iconEl.innerHTML = '<i class="fas fa-exclamation-triangle fa-2x text-danger"></i>';
                    okBtn.className = 'btn btn-danger';
                } else if (type === 'info') {
                    iconEl.innerHTML = '<i class="fas fa-info-circle fa-2x text-info"></i>';
                    okBtn.className = 'btn btn-primary';
                } else {
                    iconEl.innerHTML = '<i class="fas fa-question-circle fa-2x text-warning"></i>';
                    okBtn.className = 'btn btn-warning';
                }

                const bsModal = new bootstrap.Modal(modal);

                const handleOk = () => {
                    okBtn.removeEventListener('click', handleOk);
                    modal.removeEventListener('hidden.bs.modal', handleCancel);
                    bsModal.hide();
                    resolve(true);
                };

                const handleCancel = () => {
                    okBtn.removeEventListener('click', handleOk);
                    resolve(false);
                };

                okBtn.addEventListener('click', handleOk);
                modal.addEventListener('hidden.bs.modal', handleCancel, { once: true });
                bsModal.show();
            });
        }

        const defaults = {
            countryCodes: {{ defaultSettings['tag country codes'] | tojson }},
            resolutionPatterns: {{ defaultSettings['tag resolution patterns'] | tojson }},
            eventPatterns: {{ defaultSettings['tag event patterns'] | tojson }},
            miscPatterns: {{ defaultSettings['tag misc patterns'] | tojson }},
            headerPatterns: {{ defaultSettings['tag header patterns'] | tojson }},
        };

        const resetBtn = document.getElementById('resetTagDefaults');
        if (!resetBtn) return;

        function syncEditorsFromTextareas() {
            if (!window.TagRuleEditors) return;
            window.TagRuleEditors.forEach(function(editor) {
                editor.refreshFromTextarea();
            });
        }

        resetBtn.addEventListener('click', async function() {
            const confirmed = await showConfirmDialog({
                title: 'Reset Tag Extraction',
                message: 'Reset Tag Extraction patterns to defaults?',
                okText: 'Reset',
                type: 'warning'
            });
            if (!confirmed) return;
            document.getElementById('tag_country_codes').value = defaults.countryCodes || '';
            document.getElementById('tag_resolution_patterns').value = defaults.resolutionPatterns || '';
            document.getElementById('tag_event_patterns').value = defaults.eventPatterns || '';
            document.getElementById('tag_misc_patterns').value = defaults.miscPatterns || '';
            document.getElementById('tag_header_patterns').value = defaults.headerPatterns || '';
            syncEditorsFromTextareas();
        });

        function createRuleRow(format, value) {
            const row = document.createElement('div');
            row.className = 'tag-rule-row';
            if (format === 'label') {
                row.classList.add('tag-rule-row-label');
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.className = 'form-control form-control-sm tag-rule-label';
                labelInput.placeholder = 'LABEL';
                const regexInput = document.createElement('input');
                regexInput.type = 'text';
                regexInput.className = 'form-control form-control-sm tag-rule-regex';
                regexInput.placeholder = 'REGEX';
                if (value) {
                    labelInput.value = value.label || '';
                    regexInput.value = value.regex || '';
                }
                row.appendChild(labelInput);
                row.appendChild(regexInput);
            } else {
                row.classList.add('tag-rule-row-line');
                const lineInput = document.createElement('input');
                lineInput.type = 'text';
                lineInput.className = 'form-control form-control-sm tag-rule-value';
                lineInput.placeholder = 'REGEX';
                if (value && value.line) {
                    lineInput.value = value.line;
                }
                row.appendChild(lineInput);
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-sm btn-outline-danger tag-rule-delete';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            row.appendChild(deleteBtn);

            return row;
        }

        function initRuleEditor(group) {
            const textareaId = group.dataset.textarea;
            const format = group.dataset.format;
            const textarea = document.getElementById(textareaId);
            const list = group.querySelector('.tag-rule-list');
            const addBtn = group.querySelector('.tag-rule-add');
            const clearBtn = group.querySelector('.tag-rule-clear');
            const toggleRawBtn = group.querySelector('.tag-rule-toggle-raw');
            const rawWrap = group.querySelector('.tag-rule-raw');

            function serialize() {
                const lines = [];
                const rows = Array.from(list.querySelectorAll('.tag-rule-row'));
                rows.forEach(function(row) {
                    if (format === 'label') {
                        const label = row.querySelector('.tag-rule-label').value.trim();
                        const regex = row.querySelector('.tag-rule-regex').value.trim();
                        if (label && regex) {
                            lines.push(label + '=' + regex);
                        }
                    } else {
                        const line = row.querySelector('.tag-rule-value').value.trim();
                        if (line) lines.push(line);
                    }
                });
                textarea.value = lines.join('\n');
            }

            function wireRow(row) {
                row.addEventListener('input', serialize);
                const del = row.querySelector('.tag-rule-delete');
                del.addEventListener('click', function() {
                    row.remove();
                    serialize();
                    renderEmptyState();
                });
            }

            function parseLines() {
                const lines = (textarea.value || '').split('\n').map(function(line) {
                    return line.trim();
                }).filter(Boolean);
                return lines;
            }

            function renderEmptyState() {
                if (!list.querySelector('.tag-rule-row')) {
                    const empty = document.createElement('div');
                    empty.className = 'tag-rule-empty text-muted';
                    empty.textContent = 'No rules yet';
                    list.appendChild(empty);
                } else {
                    const empty = list.querySelector('.tag-rule-empty');
                    if (empty) empty.remove();
                }
            }

            function refreshFromTextarea() {
                list.innerHTML = '';
                const lines = parseLines();
                lines.forEach(function(line) {
                    let row;
                    if (format === 'label') {
                        const index = line.indexOf('=');
                        const label = index === -1 ? line : line.slice(0, index);
                        const regex = index === -1 ? '' : line.slice(index + 1);
                        row = createRuleRow(format, { label: label, regex: regex });
                    } else {
                        row = createRuleRow(format, { line: line });
                    }
                    list.appendChild(row);
                    wireRow(row);
                });
                renderEmptyState();
            }

            addBtn.addEventListener('click', function() {
                const row = createRuleRow(format);
                list.appendChild(row);
                wireRow(row);
                renderEmptyState();
                serialize();
            });

            clearBtn.addEventListener('click', function() {
                list.innerHTML = '';
                serialize();
                renderEmptyState();
            });

            toggleRawBtn.addEventListener('click', function() {
                const showingRaw = !rawWrap.classList.contains('d-none');
                if (showingRaw) {
                    rawWrap.classList.add('d-none');
                    list.classList.remove('d-none');
                    refreshFromTextarea();
                } else {
                    rawWrap.classList.remove('d-none');
                    list.classList.add('d-none');
                }
            });

            refreshFromTextarea();

            return { refreshFromTextarea: refreshFromTextarea };
        }

        window.TagRuleEditors = Array.from(document.querySelectorAll('.tag-rule-group')).map(initRuleEditor);

        (function() {
            const input = document.getElementById('epgSourcesInput');
            const list = document.getElementById('epgSourcesList');
            const addBtn = document.getElementById('addEpgSourceBtn');
            const saveBtn = document.getElementById('saveEpgSourceBtn');
            const modalEl = document.getElementById('epgSourceModal');

            if (!input || !list || !addBtn || !saveBtn || !modalEl) return;

            let epgSources = [];
            let modal = null;

            function loadSources() {
                try {
                    const raw = input.value || '[]';
                    const parsed = JSON.parse(raw);
                    epgSources = Array.isArray(parsed) ? parsed : [];
                } catch (e) {
                    epgSources = [];
                }
            }

            function saveSources() {
                input.value = JSON.stringify(epgSources);
            }

            function persistSources() {
                return fetch('/api/settings/epg_sources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sources: input.value })
                }).then(function(resp) { return resp.json(); }).catch(function() { return null; });
            }

            function normalizeSource(source) {
                const url = (source.url || '').trim();
                const computedId = url
                    ? btoa(unescape(encodeURIComponent(url)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=+$/g, '')
                    : '';
                return {
                    id: source.id || computedId || String(Date.now()),
                    name: (source.name || '').trim(),
                    url: url,
                    interval: Number(source.interval || source.interval_hours || 24),
                    enabled: source.enabled !== false && source.enabled !== 'false'
                };
            }

            function renderSources() {
                list.innerHTML = '';
                if (!epgSources.length) {
                    const empty = document.createElement('div');
                    empty.className = 'text-muted small';
                    empty.textContent = 'No EPG sources configured yet.';
                    list.appendChild(empty);
                    return;
                }

                epgSources.forEach(function(source) {
                    const row = document.createElement('div');
                    row.className = 'epg-source-row';
                    row.innerHTML = `
                        <div class="epg-source-main">
                            <div class="epg-source-title">${source.name || 'Unnamed Source'}</div>
                            <div class="epg-source-meta">
                                <span>${source.url || 'No URL'}</span>
                                <span>Â· ${source.interval || 24}h</span>
                            </div>
                        </div>
                        <div class="epg-source-actions">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" ${source.enabled ? 'checked' : ''} data-action="toggle">
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-action="refresh" title="Refresh">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-action="edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;

                    row.querySelector('[data-action="toggle"]').addEventListener('change', function(e) {
                        source.enabled = e.target.checked;
                        saveSources();
                        persistSources();
                    });
                    row.querySelector('[data-action="refresh"]').addEventListener('click', function() {
                        refreshSource(source.id);
                    });
                    row.querySelector('[data-action="edit"]').addEventListener('click', function() {
                        openModal(source);
                    });
                    row.querySelector('[data-action="delete"]').addEventListener('click', async function() {
                        const confirmed = await showConfirmDialog({
                            title: 'Remove EPG Source',
                            message: 'Remove this EPG source?',
                            okText: 'Remove',
                            type: 'danger'
                        });
                        if (!confirmed) return;
                        epgSources = epgSources.filter(function(item) { return item.id !== source.id; });
                        saveSources();
                        persistSources();
                        renderSources();
                    });

                    list.appendChild(row);
                });
            }

            function openModal(source) {
                const data = source ? normalizeSource(source) : { id: '', name: '', url: '', interval: 24, enabled: true };
                document.getElementById('epgSourceId').value = data.id || '';
                document.getElementById('epgSourceName').value = data.name || '';
                document.getElementById('epgSourceUrl').value = data.url || '';
                document.getElementById('epgSourceInterval').value = data.interval || 24;
                document.getElementById('epgSourceEnabled').checked = data.enabled !== false;
                if (!modal && window.bootstrap) {
                    modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                }
                if (modal) modal.show();
            }

            function saveModal() {
                const id = document.getElementById('epgSourceId').value || String(Date.now());
                const source = {
                    id: id,
                    name: document.getElementById('epgSourceName').value.trim(),
                    url: document.getElementById('epgSourceUrl').value.trim(),
                    interval: Number(document.getElementById('epgSourceInterval').value || 24),
                    enabled: document.getElementById('epgSourceEnabled').checked
                };

                if (!source.url) {
                    alert('Please enter a valid XMLTV URL.');
                    return;
                }

                const existing = epgSources.find(function(item) { return item.id === id; });
                if (existing) {
                    Object.assign(existing, source);
                } else {
                    epgSources.push(source);
                }

                saveSources();
                persistSources();
                renderSources();
                if (!modal && window.bootstrap) {
                    modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                }
                if (modal) modal.hide();
                refreshSource(source.id);
            }

            addBtn.addEventListener('click', function() {
                openModal();
            });
            saveBtn.addEventListener('click', saveModal);

            function refreshSource(id) {
                if (!id) return;
                fetch('/api/epg/source/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                })
                    .then(function(resp) { return resp.json(); })
                    .then(function(data) {
                        if (data && data.ok) {
                            if (typeof showToast === 'function') {
                                showToast('EPG source refresh started.', 'info');
                            }
                        } else {
                            if (typeof showToast === 'function') {
                                showToast('EPG source refresh failed.', 'error');
                            }
                        }
                    })
                    .catch(function() {
                        if (typeof showToast === 'function') {
                            showToast('EPG source refresh failed.', 'error');
                        }
                    });
            }

            loadSources();
            epgSources = epgSources.map(normalizeSource);
            saveSources();
            persistSources();
            renderSources();
        })();

        function runVacuumNow(endpoint, label) {
            const status = document.getElementById('dbCleanupStatus');
            status.textContent = `${label} running...`;
            fetch(endpoint, { method: 'POST' })
                .then(function(resp) { return resp.json(); })
                .then(function(data) {
                    if (!data || data.ok === false) {
                        status.textContent = `${label} failed.`;
                        return;
                    }
                    const extra = data.count !== undefined ? ` (${data.count} dbs)` : '';
                    status.textContent = `${label} completed${extra}.`;
                })
                .catch(function() {
                    status.textContent = `${label} failed.`;
                });
        }

        const vacuumChannelsBtn = document.getElementById('vacuumChannelsNow');
        const vacuumEpgBtn = document.getElementById('vacuumEpgNow');
        if (vacuumChannelsBtn) {
            vacuumChannelsBtn.addEventListener('click', async function() {
                const confirmed = await showConfirmDialog({
                    title: 'Vacuum Channels DB',
                    message: 'Run VACUUM on channels.db now?',
                    okText: 'Vacuum',
                    type: 'info'
                });
                if (confirmed) {
                    runVacuumNow('/api/settings/vacuum/channels', 'Vacuum channels.db');
                }
            });
        }
        if (vacuumEpgBtn) {
            vacuumEpgBtn.addEventListener('click', async function() {
                const confirmed = await showConfirmDialog({
                    title: 'Vacuum EPG DBs',
                    message: 'Run VACUUM on all EPG DBs now?',
                    okText: 'Vacuum',
                    type: 'info'
                });
                if (confirmed) {
                    runVacuumNow('/api/settings/vacuum/epg', 'Vacuum EPG DBs');
                }
            });
        }
    })();
</script>
{% endblock %} 
